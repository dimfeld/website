---
title: "Selective Closure Capture in Rust"
tags: Rust
date: 2020-08-11
updated: 2020-08-17
---


  <ul class="list-document">
    <li id="BGozMGWJc">Sometimes in Rust you may have a closure that needs to move some values but not others. If all the values satisfy the <code>Copy</code> this is easy, but that it usually not the case.</li>
    <li id="aZsULnuPX">Sometimes we need to move some values into a closure, but want to borrow others. </li>
    <li id="3pdDxNSbO">You can solve this problem by creating new bindings for the by-reference values, so that the closure moves the references instead of the original value. It&#39;s not pretty but it works well.</li>
    <li id="e9KKf7qEX"><pre><code><span class="hljs-source hljs-clojure">let threads = vec![<span class="hljs-meta hljs-sexpr hljs-clojure">(<span class="hljs-string hljs-quoted hljs-double hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-clojure">&quot;</span>referrers<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-clojure">&quot;</span></span>, <span class="hljs-string hljs-quoted hljs-double hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-clojure">&quot;</span>s<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-clojure">&quot;</span></span>)</span>, <span class="hljs-meta hljs-sexpr hljs-clojure">(<span class="hljs-string hljs-quoted hljs-double hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-clojure">&quot;</span>referrals<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-clojure">&quot;</span></span>, <span class="hljs-string hljs-quoted hljs-double hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-clojure">&quot;</span>o<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-clojure">&quot;</span></span>)</span>]<span class="hljs-comment hljs-line hljs-semicolon hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-comment hljs-clojure">;</span>
</span>thread::scope<span class="hljs-meta hljs-sexpr hljs-clojure">(|<span class="hljs-source hljs-symbol hljs-clojure">s</span>| <span class="hljs-meta hljs-expression hljs-map hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-map hljs-begin hljs-clojure">{</span>
    <span class="hljs-support hljs-function hljs-match hljs-clojure">for</span> <span class="hljs-meta hljs-sexpr hljs-clojure">(<span class="hljs-source hljs-symbol hljs-clojure">description</span>, <span class="hljs-source hljs-symbol hljs-clojure">field</span>)</span> <span class="hljs-source hljs-symbol hljs-clojure">in</span> <span class="hljs-source hljs-symbol hljs-clojure">threads</span> <span class="hljs-meta hljs-expression hljs-map hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-map hljs-begin hljs-clojure">{</span>
        <span class="hljs-keyword hljs-operator hljs-clojure">/</span><span class="hljs-keyword hljs-operator hljs-clojure">/</span> <span class="hljs-source hljs-symbol hljs-clojure">Get</span> <span class="hljs-source hljs-symbol hljs-clojure">variables</span> <span class="hljs-source hljs-symbol hljs-clojure">explicitly</span> <span class="hljs-source hljs-symbol hljs-clojure">as</span> <span class="hljs-source hljs-symbol hljs-clojure">references</span> <span class="hljs-source hljs-symbol hljs-clojure">so</span> <span class="hljs-source hljs-symbol hljs-clojure">that</span> <span class="hljs-source hljs-symbol hljs-clojure">the</span> <span class="hljs-source hljs-symbol hljs-clojure">closure</span>
        <span class="hljs-keyword hljs-operator hljs-clojure">/</span><span class="hljs-keyword hljs-operator hljs-clojure">/</span> <span class="hljs-source hljs-symbol hljs-clojure">moves</span> <span class="hljs-source hljs-symbol hljs-clojure">only</span> <span class="hljs-source hljs-symbol hljs-clojure">the</span> <span class="hljs-source hljs-symbol hljs-clojure">references</span>.
        <span class="hljs-keyword hljs-control hljs-clojure">let</span> <span class="hljs-source hljs-symbol hljs-clojure">idmapper</span> <span class="hljs-keyword hljs-operator hljs-clojure">=</span> &amp;<span class="hljs-source hljs-symbol hljs-clojure">idmapper</span><span class="hljs-comment hljs-line hljs-semicolon hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-comment hljs-clojure">;</span>
</span>        <span class="hljs-keyword hljs-control hljs-clojure">let</span> <span class="hljs-source hljs-symbol hljs-clojure">input_path</span> <span class="hljs-keyword hljs-operator hljs-clojure">=</span> &amp;<span class="hljs-source hljs-symbol hljs-clojure">input_path</span><span class="hljs-comment hljs-line hljs-semicolon hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-comment hljs-clojure">;</span>
</span>        <span class="hljs-keyword hljs-control hljs-clojure">let</span> <span class="hljs-source hljs-symbol hljs-clojure">output_path</span> <span class="hljs-keyword hljs-operator hljs-clojure">=</span> &amp;<span class="hljs-source hljs-symbol hljs-clojure">output_path</span><span class="hljs-comment hljs-line hljs-semicolon hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-comment hljs-clojure">;</span>
</span>        <span class="hljs-keyword hljs-control hljs-clojure">let</span> <span class="hljs-source hljs-symbol hljs-clojure">logger</span> <span class="hljs-keyword hljs-operator hljs-clojure">=</span> &amp;<span class="hljs-source hljs-symbol hljs-clojure">logger</span><span class="hljs-comment hljs-line hljs-semicolon hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-comment hljs-clojure">;</span>
</span>        <span class="hljs-keyword hljs-control hljs-clojure">let</span> <span class="hljs-source hljs-symbol hljs-clojure">file_prefix</span> <span class="hljs-keyword hljs-operator hljs-clojure">=</span> &amp;<span class="hljs-source hljs-symbol hljs-clojure">file_prefix</span><span class="hljs-comment hljs-line hljs-semicolon hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-comment hljs-clojure">;</span>
</span>        <span class="hljs-source hljs-symbol hljs-clojure">s</span><span class="hljs-keyword hljs-operator hljs-classpath hljs-clojure">.</span><span class="hljs-source hljs-symbol hljs-clojure">spawn</span><span class="hljs-meta hljs-sexpr hljs-clojure">(<span class="hljs-source hljs-symbol hljs-clojure">move</span> |<span class="hljs-source hljs-symbol hljs-clojure">_</span>| <span class="hljs-meta hljs-expression hljs-map hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-map hljs-begin hljs-clojure">{</span>
            <span class="hljs-source hljs-symbol hljs-clojure">write_relationships_table</span><span class="hljs-meta hljs-sexpr hljs-clojure">(
                &amp;<span class="hljs-source hljs-symbol hljs-clojure">logger</span>,
                &amp;<span class="hljs-source hljs-symbol hljs-clojure">idmapper</span>,
                <span class="hljs-source hljs-symbol hljs-clojure">description</span>,
                &amp;<span class="hljs-source hljs-symbol hljs-clojure">input_path</span>,
                &amp;<span class="hljs-source hljs-symbol hljs-clojure">output_path</span>,
                <span class="hljs-source hljs-symbol hljs-clojure">file_prefix</span><span class="hljs-keyword hljs-operator hljs-classpath hljs-clojure">.</span><span class="hljs-source hljs-symbol hljs-clojure">as_str</span><span class="hljs-constant hljs-language hljs-clojure">()</span>,
                <span class="hljs-source hljs-symbol hljs-clojure">field</span>,
                <span class="hljs-source hljs-symbol hljs-clojure">max_year</span>,
            )</span><span class="hljs-comment hljs-line hljs-semicolon hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-comment hljs-clojure">;</span>
</span>        <span class="hljs-punctuation hljs-definition hljs-map hljs-end hljs-clojure">}</span></span>)</span><span class="hljs-comment hljs-line hljs-semicolon hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-comment hljs-clojure">;</span>
</span>    <span class="hljs-punctuation hljs-definition hljs-map hljs-end hljs-clojure">}</span></span>
<span class="hljs-punctuation hljs-definition hljs-map hljs-end hljs-clojure">}</span></span>)</span>
.unwrap()<span class="hljs-comment hljs-line hljs-semicolon hljs-clojure"><span class="hljs-punctuation hljs-definition hljs-comment hljs-clojure">;</span></span></span></code></pre></li>
    <li id="SK0KuyNvJ">This is done by making it a <code>move</code> closure, and rebinding the variables that we want to borrow as references.</li>
  </ul>


