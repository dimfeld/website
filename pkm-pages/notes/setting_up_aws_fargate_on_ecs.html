---
title: "Setting up AWS Fargate on ECS"
tags: AWS
date: 2024-02-29
updated: 2024-03-01
---


  <ul class="list-bullet">
    <li>This mostly focuses on using Fargate for one-off jobs. Configuration is in Terraform.</li>
    <li>Set up a <a href="/notes/aws_vpc_configuration">VPC for your Cluster</a> if you need to.</li>
    <li>ECS Cluster
      <ul class="list-bullet">
        <li>You need to create an ECS cluster but it doesn&#39;t need any configuration beyond being created.</li>
        <li><pre><code><span class="sy-source sy-terraform"><span class="sy-meta sy-type sy-terraform"><span class="sy-storage sy-type sy-terraform">resource</span> <span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>aws_ecs_cluster<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span> <span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>pipeline<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
  <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">name</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>pipeline<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>
<span class="sy-punctuation sy-section sy-block sy-end sy-terraform">}</span></span>
</span></code></pre></li>
      </ul>    </li>
    <li>Running on ARM
      <ul class="list-bullet">
        <li>Add <code>&quot;runtimePlatform&quot;: { &quot;cpuArchitecture&quot;: &quot;ARM64&quot; }</code> to your task definition.</li>
      </ul>    </li>
    <li>Roles
      <ul class="list-bullet">
        <li>A task can have a task role and an execution role.</li>
        <li>The task role is given to your containers.</li>
        <li>The execution role is given to the instance that runs your containers.</li>
        <li>Both of these need an &quot;assume role policy&quot; that allows ECS to assume those roles.</li>
        <li>Terraform for the roles. This also sets up extra S3 permissions on the task execution role in case you are sending your logs to S3 (see below).
          <ul class="list-bullet">
            <li><pre><code><span class="sy-source sy-terraform"><span class="sy-meta sy-type sy-terraform"><span class="sy-storage sy-type sy-terraform">data</span> <span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>aws_iam_policy_document<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span> <span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>ecs_assume_role<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
  <span class="sy-meta sy-type sy-terraform"><span class="sy-entity sy-name sy-type sy-terraform">statement</span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
    <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">actions</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-punctuation sy-section sy-brackets sy-begin sy-terraform">[</span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>sts:AssumeRole<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span><span class="sy-punctuation sy-section sy-brackets sy-end sy-terraform">]</span>
    <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">effect</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>Allow<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>
    <span class="sy-meta sy-type sy-terraform"><span class="sy-entity sy-name sy-type sy-terraform">principals</span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
      <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">type</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>Service<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>
      <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">identifiers</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-punctuation sy-section sy-brackets sy-begin sy-terraform">[</span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>ecs-tasks.amazonaws.com<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span><span class="sy-punctuation sy-section sy-brackets sy-end sy-terraform">]</span>
    <span class="sy-punctuation sy-section sy-block sy-end sy-terraform">}</span></span>

    <span class="sy-meta sy-type sy-terraform"><span class="sy-entity sy-name sy-type sy-terraform">condition</span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
      <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">test</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>ArnLike<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>
      <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">variable</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>aws:SourceArn<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>
      <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">values</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-punctuation sy-section sy-brackets sy-begin sy-terraform">[</span>
        <span class="sy-meta sy-function-call sy-terraform"><span class="sy-support sy-function sy-builtin sy-terraform">format</span><span class="sy-punctuation sy-section sy-parens sy-begin sy-terraform">(</span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>arn:aws:ecs:%s:%s:*<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span><span class="sy-punctuation sy-separator sy-terraform">,</span> <span class="sy-support sy-constant sy-terraform">var</span><span class="sy-keyword sy-operator sy-accessor sy-terraform">.</span><span class="sy-variable sy-other sy-member sy-terraform">aws_region</span><span class="sy-punctuation sy-separator sy-terraform">,</span> <span class="sy-support sy-constant sy-terraform">var</span><span class="sy-keyword sy-operator sy-accessor sy-terraform">.</span><span class="sy-variable sy-other sy-member sy-terraform">aws_account_id</span><span class="sy-punctuation sy-section sy-parens sy-end sy-terraform">)</span></span>
      <span class="sy-punctuation sy-section sy-brackets sy-end sy-terraform">]</span>
    <span class="sy-punctuation sy-section sy-block sy-end sy-terraform">}</span></span>

    <span class="sy-meta sy-type sy-terraform"><span class="sy-entity sy-name sy-type sy-terraform">condition</span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
      <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">test</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>StringEquals<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>
      <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">variable</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>aws:SourceAccount<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>
      <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">values</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-punctuation sy-section sy-brackets sy-begin sy-terraform">[</span>
        <span class="sy-support sy-constant sy-terraform">var</span><span class="sy-keyword sy-operator sy-accessor sy-terraform">.</span><span class="sy-variable sy-other sy-member sy-terraform">aws_account_id</span>
      <span class="sy-punctuation sy-section sy-brackets sy-end sy-terraform">]</span>
    <span class="sy-punctuation sy-section sy-block sy-end sy-terraform">}</span></span>

  <span class="sy-punctuation sy-section sy-block sy-end sy-terraform">}</span></span>
<span class="sy-punctuation sy-section sy-block sy-end sy-terraform">}</span></span>

<span class="sy-meta sy-type sy-terraform"><span class="sy-storage sy-type sy-terraform">resource</span> <span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>aws_iam_role<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span> <span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>my_task_execution_role<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
  <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">name</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>fargate_my_task_execution<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>

  <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">assume_role_policy</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-support sy-constant sy-terraform">data</span><span class="sy-keyword sy-operator sy-accessor sy-terraform">.</span><span class="sy-variable sy-other sy-member sy-terraform">aws_iam_policy_document</span><span class="sy-keyword sy-operator sy-accessor sy-terraform">.</span><span class="sy-variable sy-other sy-member sy-terraform">ecs_assume_role</span><span class="sy-keyword sy-operator sy-accessor sy-terraform">.</span><span class="sy-variable sy-other sy-member sy-terraform">json</span>

  <span class="sy-meta sy-type sy-terraform"><span class="sy-entity sy-name sy-type sy-terraform">inline_policy</span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
    <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">name</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>s3_put<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>
    <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">policy</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-meta sy-function-call sy-terraform"><span class="sy-support sy-function sy-builtin sy-terraform">jsonencode</span><span class="sy-punctuation sy-section sy-parens sy-begin sy-terraform">(</span><span class="sy-meta sy-braces sy-terraform"><span class="sy-punctuation sy-section sy-braces sy-begin sy-terraform">{</span>
      &quot;Version&quot;: &quot;2012-10-17&quot;,
      &quot;Statement&quot;: [        
        {
          &quot;Effect&quot;: &quot;Allow&quot;,
          &quot;Action&quot;: [
             &quot;s3:*&quot;
          ],
          &quot;Resource&quot;: [
            &quot;arn:aws:s3:::my-app-logs&quot;,
            &quot;arn:aws:s3:::my-app-logs<span class="sy-comment sy-block sy-terraform"><span class="sy-punctuation sy-definition sy-comment sy-terraform">/*</span>&quot;
           ]
        },
        {
          &quot;Effect&quot;: &quot;Allow&quot;,
          &quot;Action&quot;: [
            &quot;ecr:GetAuthorizationToken&quot;,
            &quot;logs:CreateLogGroup&quot;,
            &quot;logs:CreateLogStream&quot;,
            &quot;logs:PutLogEvents&quot;
          ],
          &quot;Resource&quot;: &quot;*&quot;
        },
        {
          &quot;Effect&quot;: &quot;Allow&quot;,
          &quot;Action&quot;: [
            &quot;ecr:BatchCheckLayerAvailability&quot;,
            &quot;ecr:BatchGetImage&quot;,
            &quot;ecr:DescribeImages&quot;,
            &quot;ecr:DescribeRepositories&quot;,
            &quot;ecr:GetDownloadUrlForLayer&quot;,
            &quot;ecr:GetRepositoryPolicy&quot;,
            &quot;ecr:Images&quot;
          ],
          &quot;Resource&quot;: [
            format(&quot;arn:aws:ecr:%s:%s:repository/*&quot;, var.aws_region, var.aws_account_id)
          ]
        }
      ]
    })
  }
}

resource &quot;aws_iam_role&quot; &quot;my_task_role&quot; {
  name = &quot;fargate_my_task&quot;

  assume_role_policy = data.aws_iam_policy_document.ecs_assume_role.json

  inline_policy {
    name = &quot;s3_put&quot;
    policy = jsonencode({
      &quot;Version&quot;: &quot;2012-10-17&quot;,
      &quot;Statement&quot;: [{
        &quot;Effect&quot;: &quot;Allow&quot;,
        &quot;Action&quot;: [
          &quot;s3:*&quot;
        ],
        &quot;Resource&quot;: &quot;*&quot;
      }]
    })
  }
}

output &quot;my_task_role_arn&quot; {
  value = aws_iam_role.my_task_role.arn
}

output &quot;my_task_execution_role_arn&quot; {
  value = aws_iam_role.my_task_execution_role.arn
}

</span></span></span></span></span></span></code></pre></li>
          </ul>        </li>
      </ul>    </li>
    <li>Sending Logs to S3
      <ul class="list-bullet">
        <li>Cloudwatch is the AWS-recommended way to ship logs out but you can also send them to S3.</li>
        <li>First you&#39;ll need roles like the ones in the previous section to give S3 permissions.</li>
        <li>Then create your S3 bucket.
          <ul class="list-bullet">
            <li>This configuration also autodeletes the files after 90 days.</li>
            <li><pre><code><span class="sy-source sy-terraform"><span class="sy-meta sy-type sy-terraform"><span class="sy-storage sy-type sy-terraform">resource</span> <span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>aws_s3_bucket<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span> <span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>my_app_logs<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
  <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">bucket</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>my-app-logs<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>
<span class="sy-punctuation sy-section sy-block sy-end sy-terraform">}</span></span>

<span class="sy-meta sy-type sy-terraform"><span class="sy-storage sy-type sy-terraform">resource</span> <span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>aws_s3_bucket_lifecycle_configuration<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span> <span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>my_app_logs<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
  <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">bucket</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span>aws_s3_bucket<span class="sy-keyword sy-operator sy-accessor sy-terraform">.</span><span class="sy-variable sy-other sy-member sy-terraform">my_app_logs</span><span class="sy-keyword sy-operator sy-accessor sy-terraform">.</span><span class="sy-variable sy-other sy-member sy-terraform">id</span>
  <span class="sy-meta sy-type sy-terraform"><span class="sy-entity sy-name sy-type sy-terraform">rule</span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
    <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">id</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>delete-old-logs<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>
    <span class="sy-meta sy-type sy-terraform"><span class="sy-entity sy-name sy-type sy-terraform">expiration</span> <span class="sy-meta sy-block sy-terraform"><span class="sy-punctuation sy-section sy-block sy-begin sy-terraform">{</span></span></span><span class="sy-meta sy-block sy-terraform">
      <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">days</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-constant sy-numeric sy-integer sy-terraform">90</span>
    <span class="sy-punctuation sy-section sy-block sy-end sy-terraform">}</span></span>
    <span class="sy-variable sy-declaration sy-terraform"><span class="sy-variable sy-other sy-readwrite sy-terraform">status</span> <span class="sy-keyword sy-operator sy-assignment sy-terraform">= </span></span><span class="sy-string sy-quoted sy-double sy-terraform"><span class="sy-punctuation sy-definition sy-string sy-begin sy-terraform">&quot;</span>Enabled<span class="sy-punctuation sy-definition sy-string sy-end sy-terraform">&quot;</span></span>
  <span class="sy-punctuation sy-section sy-block sy-end sy-terraform">}</span></span>
<span class="sy-punctuation sy-section sy-block sy-end sy-terraform">}</span></span>

</span></code></pre></li>
          </ul>        </li>
        <li>Then set up your task definition like so.</li>
        <li><pre><code><span class="sy-source sy-js"><span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
  <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>taskRoleArn<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span>: <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>ARN of the task role above<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-keyword sy-operator sy-comma sy-js">,</span>
  <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>executionRoleArn<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span>: <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>ARN of execution role above<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-keyword sy-operator sy-comma sy-js">,</span>
  <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>requiresCompatibilities<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span>: <span class="sy-meta sy-sequence sy-js"><span class="sy-punctuation sy-section sy-brackets sy-begin sy-js">[</span><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>FARGATE<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-section sy-brackets sy-end sy-js">]</span></span><span class="sy-keyword sy-operator sy-comma sy-js">,</span>
  <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>containerDefinitions<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span>: <span class="sy-meta sy-sequence sy-js"><span class="sy-punctuation sy-section sy-brackets sy-begin sy-js">[</span>
    <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> Only needed for custom log routing.
</span>    <span class="sy-meta sy-mapping sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
      <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>name<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>log_router<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
      <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>essential<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-constant sy-language sy-boolean sy-true sy-js">true</span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
      <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>image<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>amazon/aws-for-fluent-bit:stable<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
      <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>firelensConfiguration<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-mapping sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
        <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>type<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>fluentbit<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span>
      <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
      <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>logConfiguration<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-mapping sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
        <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>logDriver<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>awslogs<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
        <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>options<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-mapping sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
          <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>awslogs-group<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>firelens-container<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
          <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>awslogs-region<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>us-west-2<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
          <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>awslogs-create-group<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>true<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
          <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>awslogs-stream-prefix<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>firelens<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span>
        <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span>
      <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
      <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>memoryReservation<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-constant sy-numeric sy-integer sy-decimal sy-js">50</span>
    <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
    <span class="sy-meta sy-mapping sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
      <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>name<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>my_app<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
      <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>image<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>acctnum.dkr.ecr.region.amazonaws.com/image:tag<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
      <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>portMappings<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-sequence sy-js"><span class="sy-punctuation sy-section sy-brackets sy-begin sy-js">[</span><span class="sy-punctuation sy-section sy-brackets sy-end sy-js">]</span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
      <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>essential<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-constant sy-language sy-boolean sy-true sy-js">true</span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
      <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>logConfiguration<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-mapping sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
        <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>logDriver<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>awsfirelens<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
        <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>options<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-mapping sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
          <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>Name<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>s3<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
          <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> Optional, to customize key format which can be useful for batch jobs
</span>          <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>s3_key_format<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span>
            <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>/%Y/%m/%Y-%m-%d-my-app-$TAG-%S<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
          <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>region<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>your-aws-region<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
          <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>bucket<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>my-app-logs<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
          <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> Rotate to a new log file when this size is reached.
</span>          <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> For persistent services this should be much smaller.
</span>          <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> For batch jobs I set it large since it&#39;s nice to have
</span>          <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> all the logs for a run in one file.
</span>          <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>total_file_size<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>10G<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
          <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>upload_timeout<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>1m<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
          <span class="sy-meta sy-mapping sy-key sy-js"><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>retry_limit<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span></span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>2<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span>
        <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
      <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span>
    <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span>
  <span class="sy-punctuation sy-section sy-brackets sy-end sy-js">]</span></span>
<span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span>
</span></code></pre></li>
        <li>The  <code>logConfiguration</code> options are documented at <a href="https://docs.fluentbit.io/manual/pipeline/outputs/s3">https://docs.fluentbit.io/manual/pipeline/outputs/s3</a></li>
      </ul>    </li>
  </ul>

