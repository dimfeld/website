---
title: "Selective Closure Capture in Rust"
tags: Rust
date: 2020-08-17
updated: 2020-08-17
---


  <ul class="list-bullet">
    <li>Sometimes in Rust you may have a closure that needs to move some values but not others. If all the values satisfy the <code>Copy</code> this is easy, but that it usually not the case.</li>
    <li>Sometimes we need to move some values into a closure, but want to borrow others. </li>
    <li>You can solve this problem by creating new bindings for the by-reference values, so that the closure moves the references instead of the original value. It&#39;s not pretty but it works well.</li>
    <li>
<pre><code><span class="sy-source sy-clojure">let threads = vec![<span class="sy-meta sy-sexpr sy-clojure">(<span class="sy-string sy-quoted sy-double sy-clojure"><span class="sy-punctuation sy-definition sy-string sy-begin sy-clojure">&quot;</span>referrers<span class="sy-punctuation sy-definition sy-string sy-end sy-clojure">&quot;</span></span>, <span class="sy-string sy-quoted sy-double sy-clojure"><span class="sy-punctuation sy-definition sy-string sy-begin sy-clojure">&quot;</span>s<span class="sy-punctuation sy-definition sy-string sy-end sy-clojure">&quot;</span></span>)</span>, <span class="sy-meta sy-sexpr sy-clojure">(<span class="sy-string sy-quoted sy-double sy-clojure"><span class="sy-punctuation sy-definition sy-string sy-begin sy-clojure">&quot;</span>referrals<span class="sy-punctuation sy-definition sy-string sy-end sy-clojure">&quot;</span></span>, <span class="sy-string sy-quoted sy-double sy-clojure"><span class="sy-punctuation sy-definition sy-string sy-begin sy-clojure">&quot;</span>o<span class="sy-punctuation sy-definition sy-string sy-end sy-clojure">&quot;</span></span>)</span>]<span class="sy-comment sy-line sy-semicolon sy-clojure"><span class="sy-punctuation sy-definition sy-comment sy-clojure">;</span>
</span>thread::scope<span class="sy-meta sy-sexpr sy-clojure">(|<span class="sy-source sy-symbol sy-clojure">s</span>| <span class="sy-meta sy-expression sy-map sy-clojure"><span class="sy-punctuation sy-definition sy-map sy-begin sy-clojure">{</span>
  <span class="sy-support sy-function sy-match sy-clojure">for</span> <span class="sy-meta sy-sexpr sy-clojure">(<span class="sy-source sy-symbol sy-clojure">description</span>, <span class="sy-source sy-symbol sy-clojure">field</span>)</span> <span class="sy-source sy-symbol sy-clojure">in</span> <span class="sy-source sy-symbol sy-clojure">threads</span> <span class="sy-meta sy-expression sy-map sy-clojure"><span class="sy-punctuation sy-definition sy-map sy-begin sy-clojure">{</span>
      <span class="sy-keyword sy-operator sy-clojure">/</span><span class="sy-keyword sy-operator sy-clojure">/</span> <span class="sy-source sy-symbol sy-clojure">Get</span> <span class="sy-source sy-symbol sy-clojure">variables</span> <span class="sy-source sy-symbol sy-clojure">explicitly</span> <span class="sy-source sy-symbol sy-clojure">as</span> <span class="sy-source sy-symbol sy-clojure">references</span> <span class="sy-source sy-symbol sy-clojure">so</span> <span class="sy-source sy-symbol sy-clojure">that</span> <span class="sy-source sy-symbol sy-clojure">the</span> <span class="sy-source sy-symbol sy-clojure">closure</span>
      <span class="sy-keyword sy-operator sy-clojure">/</span><span class="sy-keyword sy-operator sy-clojure">/</span> <span class="sy-source sy-symbol sy-clojure">moves</span> <span class="sy-source sy-symbol sy-clojure">only</span> <span class="sy-source sy-symbol sy-clojure">the</span> <span class="sy-source sy-symbol sy-clojure">references</span>.
      <span class="sy-keyword sy-control sy-clojure">let</span> <span class="sy-source sy-symbol sy-clojure">idmapper</span> <span class="sy-keyword sy-operator sy-clojure">=</span> &amp;<span class="sy-source sy-symbol sy-clojure">idmapper</span><span class="sy-comment sy-line sy-semicolon sy-clojure"><span class="sy-punctuation sy-definition sy-comment sy-clojure">;</span>
</span>      <span class="sy-keyword sy-control sy-clojure">let</span> <span class="sy-source sy-symbol sy-clojure">input_path</span> <span class="sy-keyword sy-operator sy-clojure">=</span> &amp;<span class="sy-source sy-symbol sy-clojure">input_path</span><span class="sy-comment sy-line sy-semicolon sy-clojure"><span class="sy-punctuation sy-definition sy-comment sy-clojure">;</span>
</span>      <span class="sy-keyword sy-control sy-clojure">let</span> <span class="sy-source sy-symbol sy-clojure">output_path</span> <span class="sy-keyword sy-operator sy-clojure">=</span> &amp;<span class="sy-source sy-symbol sy-clojure">output_path</span><span class="sy-comment sy-line sy-semicolon sy-clojure"><span class="sy-punctuation sy-definition sy-comment sy-clojure">;</span>
</span>      <span class="sy-keyword sy-control sy-clojure">let</span> <span class="sy-source sy-symbol sy-clojure">logger</span> <span class="sy-keyword sy-operator sy-clojure">=</span> &amp;<span class="sy-source sy-symbol sy-clojure">logger</span><span class="sy-comment sy-line sy-semicolon sy-clojure"><span class="sy-punctuation sy-definition sy-comment sy-clojure">;</span>
</span>      <span class="sy-keyword sy-control sy-clojure">let</span> <span class="sy-source sy-symbol sy-clojure">file_prefix</span> <span class="sy-keyword sy-operator sy-clojure">=</span> &amp;<span class="sy-source sy-symbol sy-clojure">file_prefix</span><span class="sy-comment sy-line sy-semicolon sy-clojure"><span class="sy-punctuation sy-definition sy-comment sy-clojure">;</span>
</span>      <span class="sy-source sy-symbol sy-clojure">s</span><span class="sy-keyword sy-operator sy-classpath sy-clojure">.</span><span class="sy-source sy-symbol sy-clojure">spawn</span><span class="sy-meta sy-sexpr sy-clojure">(<span class="sy-source sy-symbol sy-clojure">move</span> |<span class="sy-source sy-symbol sy-clojure">_</span>| <span class="sy-meta sy-expression sy-map sy-clojure"><span class="sy-punctuation sy-definition sy-map sy-begin sy-clojure">{</span>
          <span class="sy-source sy-symbol sy-clojure">write_relationships_table</span><span class="sy-meta sy-sexpr sy-clojure">(
              &amp;<span class="sy-source sy-symbol sy-clojure">logger</span>,
              &amp;<span class="sy-source sy-symbol sy-clojure">idmapper</span>,
              <span class="sy-source sy-symbol sy-clojure">description</span>,
              &amp;<span class="sy-source sy-symbol sy-clojure">input_path</span>,
              &amp;<span class="sy-source sy-symbol sy-clojure">output_path</span>,
              <span class="sy-source sy-symbol sy-clojure">file_prefix</span><span class="sy-keyword sy-operator sy-classpath sy-clojure">.</span><span class="sy-source sy-symbol sy-clojure">as_str</span><span class="sy-constant sy-language sy-clojure">()</span>,
              <span class="sy-source sy-symbol sy-clojure">field</span>,
              <span class="sy-source sy-symbol sy-clojure">max_year</span>,
          )</span><span class="sy-comment sy-line sy-semicolon sy-clojure"><span class="sy-punctuation sy-definition sy-comment sy-clojure">;</span>
</span>      <span class="sy-punctuation sy-definition sy-map sy-end sy-clojure">}</span></span>)</span><span class="sy-comment sy-line sy-semicolon sy-clojure"><span class="sy-punctuation sy-definition sy-comment sy-clojure">;</span>
</span>  <span class="sy-punctuation sy-definition sy-map sy-end sy-clojure">}</span></span>
<span class="sy-punctuation sy-definition sy-map sy-end sy-clojure">}</span></span>)</span>
.unwrap()<span class="sy-comment sy-line sy-semicolon sy-clojure"><span class="sy-punctuation sy-definition sy-comment sy-clojure">;</span>
</span></span></code></pre></li>
    <li>This is done by making it a <code>move</code> closure, and rebinding the variables that we want to borrow as references.</li>
  </ul>

