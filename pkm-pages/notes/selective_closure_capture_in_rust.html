---
title: "Selective Closure Capture in Rust"
tags: Rust
date: 2020-08-17
updated: 2023-10-08
---


  <ul class="list-bullet">
    <li>Sometimes in Rust you may have a closure that needs to move some values but not others. If all the values satisfy the <code>Copy</code> this is easy, but that it usually not the case.</li>
    <li>Sometimes we need to move some values into a closure, but want to borrow others.</li>
    <li>You can solve this problem by creating new bindings for the by-reference values, so that the closure moves the references instead of the original value. It&#39;s not pretty but it works well.</li>
    <li><pre><code><span class="sy-source sy-rust"><span class="sy-storage sy-type sy-rust">let</span> threads <span class="sy-keyword sy-operator sy-assignment sy-rust">=</span> <span class="sy-support sy-macro sy-rust">vec!</span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-begin sy-rust">[</span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-begin sy-rust">(</span><span class="sy-string sy-quoted sy-double sy-rust"><span class="sy-punctuation sy-definition sy-string sy-begin sy-rust">&quot;</span>referrers<span class="sy-punctuation sy-definition sy-string sy-end sy-rust">&quot;</span></span><span class="sy-punctuation sy-separator sy-rust">,</span> <span class="sy-string sy-quoted sy-double sy-rust"><span class="sy-punctuation sy-definition sy-string sy-begin sy-rust">&quot;</span>s<span class="sy-punctuation sy-definition sy-string sy-end sy-rust">&quot;</span></span></span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-end sy-rust">)</span></span><span class="sy-punctuation sy-separator sy-rust">,</span> <span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-begin sy-rust">(</span><span class="sy-string sy-quoted sy-double sy-rust"><span class="sy-punctuation sy-definition sy-string sy-begin sy-rust">&quot;</span>referrals<span class="sy-punctuation sy-definition sy-string sy-end sy-rust">&quot;</span></span><span class="sy-punctuation sy-separator sy-rust">,</span> <span class="sy-string sy-quoted sy-double sy-rust"><span class="sy-punctuation sy-definition sy-string sy-begin sy-rust">&quot;</span>o<span class="sy-punctuation sy-definition sy-string sy-end sy-rust">&quot;</span></span></span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-end sy-rust">)</span></span><span class="sy-punctuation sy-section sy-group sy-end sy-rust">]</span></span><span class="sy-punctuation sy-terminator sy-rust">;</span>
<span class="sy-meta sy-path sy-rust">thread<span class="sy-punctuation sy-accessor sy-rust">::</span></span>scope<span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-begin sy-rust">(</span><span class="sy-meta sy-function sy-closure sy-rust"><span class="sy-meta sy-function sy-parameters sy-rust"><span class="sy-punctuation sy-section sy-parameters sy-begin sy-rust">|</span></span></span><span class="sy-meta sy-function sy-closure sy-rust"><span class="sy-meta sy-function sy-parameters sy-rust"><span class="sy-variable sy-parameter sy-rust">s</span><span class="sy-punctuation sy-section sy-parameters sy-end sy-rust">|</span></span> </span><span class="sy-meta sy-function sy-closure sy-rust"><span class="sy-meta sy-block sy-rust"><span class="sy-punctuation sy-section sy-block sy-begin sy-rust">{</span>
  <span class="sy-keyword sy-control sy-rust">for</span> <span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-begin sy-rust">(</span>description<span class="sy-punctuation sy-separator sy-rust">,</span> field</span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-end sy-rust">)</span></span> <span class="sy-keyword sy-operator sy-rust">in</span> threads <span class="sy-meta sy-block sy-rust"><span class="sy-punctuation sy-section sy-block sy-begin sy-rust">{</span>
      <span class="sy-comment sy-line sy-double-slash sy-rust"><span class="sy-punctuation sy-definition sy-comment sy-rust">//</span> Get variables explicitly as references so that the closure
</span>      <span class="sy-comment sy-line sy-double-slash sy-rust"><span class="sy-punctuation sy-definition sy-comment sy-rust">//</span> moves only the references.
</span>      <span class="sy-storage sy-type sy-rust">let</span> idmapper <span class="sy-keyword sy-operator sy-assignment sy-rust">=</span> <span class="sy-keyword sy-operator sy-bitwise sy-rust">&amp;</span>idmapper<span class="sy-punctuation sy-terminator sy-rust">;</span>
      <span class="sy-storage sy-type sy-rust">let</span> input_path <span class="sy-keyword sy-operator sy-assignment sy-rust">=</span> <span class="sy-keyword sy-operator sy-bitwise sy-rust">&amp;</span>input_path<span class="sy-punctuation sy-terminator sy-rust">;</span>
      <span class="sy-storage sy-type sy-rust">let</span> output_path <span class="sy-keyword sy-operator sy-assignment sy-rust">=</span> <span class="sy-keyword sy-operator sy-bitwise sy-rust">&amp;</span>output_path<span class="sy-punctuation sy-terminator sy-rust">;</span>
      <span class="sy-storage sy-type sy-rust">let</span> logger <span class="sy-keyword sy-operator sy-assignment sy-rust">=</span> <span class="sy-keyword sy-operator sy-bitwise sy-rust">&amp;</span>logger<span class="sy-punctuation sy-terminator sy-rust">;</span>
      <span class="sy-storage sy-type sy-rust">let</span> file_prefix <span class="sy-keyword sy-operator sy-assignment sy-rust">=</span> <span class="sy-keyword sy-operator sy-bitwise sy-rust">&amp;</span>file_prefix<span class="sy-punctuation sy-terminator sy-rust">;</span>
      s<span class="sy-punctuation sy-accessor sy-dot sy-rust">.</span><span class="sy-support sy-function sy-rust">spawn</span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-begin sy-rust">(</span><span class="sy-storage sy-modifier sy-rust">move</span> <span class="sy-keyword sy-operator sy-bitwise sy-rust">|</span><span class="sy-keyword sy-operator sy-rust">_</span><span class="sy-keyword sy-operator sy-bitwise sy-rust">|</span> <span class="sy-meta sy-block sy-rust"><span class="sy-punctuation sy-section sy-block sy-begin sy-rust">{</span>
          <span class="sy-support sy-function sy-rust">write_relationships_table</span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-begin sy-rust">(</span>
              <span class="sy-keyword sy-operator sy-bitwise sy-rust">&amp;</span>logger<span class="sy-punctuation sy-separator sy-rust">,</span>
              <span class="sy-keyword sy-operator sy-bitwise sy-rust">&amp;</span>idmapper<span class="sy-punctuation sy-separator sy-rust">,</span>
              description<span class="sy-punctuation sy-separator sy-rust">,</span>
              <span class="sy-keyword sy-operator sy-bitwise sy-rust">&amp;</span>input_path<span class="sy-punctuation sy-separator sy-rust">,</span>
              <span class="sy-keyword sy-operator sy-bitwise sy-rust">&amp;</span>output_path<span class="sy-punctuation sy-separator sy-rust">,</span>
              file_prefix<span class="sy-punctuation sy-accessor sy-dot sy-rust">.</span><span class="sy-support sy-function sy-rust">as_str</span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-begin sy-rust">(</span></span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-end sy-rust">)</span></span><span class="sy-punctuation sy-separator sy-rust">,</span>
              field<span class="sy-punctuation sy-separator sy-rust">,</span>
              max_year<span class="sy-punctuation sy-separator sy-rust">,</span>
          </span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-end sy-rust">)</span></span><span class="sy-punctuation sy-terminator sy-rust">;</span>
      </span><span class="sy-meta sy-block sy-rust"><span class="sy-punctuation sy-section sy-block sy-end sy-rust">}</span></span></span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-end sy-rust">)</span></span><span class="sy-punctuation sy-terminator sy-rust">;</span>
  </span><span class="sy-meta sy-block sy-rust"><span class="sy-punctuation sy-section sy-block sy-end sy-rust">}</span></span>
</span><span class="sy-meta sy-block sy-rust"><span class="sy-punctuation sy-section sy-block sy-end sy-rust">}</span></span></span></span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-end sy-rust">)</span></span>
<span class="sy-punctuation sy-accessor sy-dot sy-rust">.</span><span class="sy-support sy-function sy-rust">unwrap</span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-begin sy-rust">(</span></span><span class="sy-meta sy-group sy-rust"><span class="sy-punctuation sy-section sy-group sy-end sy-rust">)</span></span><span class="sy-punctuation sy-terminator sy-rust">;</span>
</span></code></pre></li>
    <li>This is done by making it a <code>move</code> closure, and rebinding the variables that we want to borrow as references.</li>
  </ul>

