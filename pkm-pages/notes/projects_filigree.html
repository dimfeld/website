---
title: "Filigree"
tags: Projects
date: 2023-12-09
updated: 2024-01-06
---


  <ul class="list-bullet">
    <li>Filigree is a web app framework based on Rust and SvelteKit, which includes common components such as authentication and background workers, and also makes it easier to set up data models and generate SQL, endpoints, and so on to use them.</li>
    <li><h2>Task List</h2>
      <ul class="list-bullet">
        <li><h3>Up Next</h3>
          <ul class="list-bullet">
            <li><input type="checkbox" disabled  /> Generate tests for models</li>
            <li><input type="checkbox" disabled  /> Tests for users without proper permissions for each action</li>
            <li><input type="checkbox" disabled  /> Tests for login/logout</li>
          </ul>        </li>
        <li><h3>Soon</h3>
          <ul class="list-bullet">
            <li><input type="checkbox" disabled  /> Endpoints for retrieving and updating your own user</li>
            <li><input type="checkbox" disabled  /> List all permissions in a file with descriptions</li>
            <li><input type="checkbox" disabled  /> Need a default role of admin which has all the permissions. (Or actually just add a new admin permission so there&#39;s one for the global admin and one for the team admin)</li>
            <li><input type="checkbox" disabled  /> signup endpoint to create a new org that also creates default roles, adds a user, etc.</li>
            <li><input type="checkbox" disabled  /> Ability to make signup open to the public or admin-only</li>
            <li><input type="checkbox" disabled  /> Configurable &quot;create&quot; permission
              <ul class="list-bullet">
                <li>for non-individual models, the owner permission or the write permission</li>
                <li>for individual models, can be a separate global permission or always allow</li>
                <li>How to properly define configuration for these since they have two settings?
                  <ul class="list-bullet">
                    <li>Maybe make a tagged enum for permissions model, with different values for each</li>
                  </ul>                </li>
              </ul>            </li>
            <li><input type="checkbox" disabled  /> Password forgot/reset endpoints</li>
            <li><input type="checkbox" disabled  /> Integrate with email sending services</li>
            <li><input type="checkbox" disabled  /> MVP Basic email sending, enough to do password management and such</li>
            <li><input type="checkbox" disabled  /> Auto-add appropriate dependencies to Cargo.toml</li>
          </ul>        </li>
        <li><h3>Later/Maybe</h3>
          <ul class="list-bullet">
            <li>Template System
              <ul class="list-bullet">
                <li><input type="checkbox" disabled  /> Easier way to add new fields to user/org model than redefining the whole thing</li>
                <li><input type="checkbox" disabled  /> New runs diff against previous run and only apply diffed changes
                  <ul class="list-bullet">
                    <li>When running the CLI, save the generated templates (post-formatter) to a state directory</li>
                    <li>On each run, diff the generated templates against the previous state in that directory</li>
                    <li>Apply that diff to the actual output file
                      <ul class="list-bullet">
                        <li>Need a patch style that matches against nearby lines instead of just using line numbers.</li>
                      </ul>                    </li>
                    <li>Point out conflicts as they occur, probably use git style merge conflict markers</li>
                    <li><code>diffy</code> supports three-way merge so that&#39;s also worth looking at</li>
                    <li>This system allows the user to make changes to the generated files but still update the config.</li>
                    <li>Need a command to rewrite a particular file</li>
                    <li>Need a command to just regenerate the state cache, for when changing formatter settings</li>
                  </ul>                </li>
                <li><input type="checkbox" disabled  /> Data-driven default org contents, even if this just a JSON blob to start
                  <ul class="list-bullet">
                    <li>This can piggyback off of the fixture system</li>
                    <li>Considering not doing this since it may be simpler to just do it in a function.</li>
                  </ul>                </li>
                <li><input type="checkbox" disabled  /> Some way to easily add hooks to CRUD operations
                  <ul class="list-bullet">
                    <li>Developer should probably just edit the generated code here.</li>
                  </ul>                </li>
                <li><input type="checkbox" disabled  /> Initial migration should only be written once</li>
                <li><input type="checkbox" disabled  /> New models should be added in new migrations</li>
                <li><input type="checkbox" disabled  /> Columns changes to models should generate new migrations</li>
                <li><input type="checkbox" disabled  /> Models can define extra permissions</li>
                <li><input type="checkbox" disabled  /> Models can define custom functions/actions
                  <ul class="list-bullet">
                    <li>Might not do this since it may be worse DX than just adding to generated code</li>
                  </ul>                </li>
              </ul>            </li>
            <li>Authentication and Registration
              <ul class="list-bullet">
                <li><input type="checkbox" disabled  /> OAuth</li>
                <li><input type="checkbox" disabled  /> Passwordless email auth</li>
                <li><input type="checkbox" disabled  /> Password requirements
                  <ul class="list-bullet">
                    <li>length</li>
                    <li>mix of character types</li>
                  </ul>                </li>
                <li><input type="checkbox" disabled  /> Prevent reuse of recent passwords</li>
                <li><input type="checkbox" disabled  /> Expire passwords that need a rehash due to upgraded standards</li>
                <li><input type="checkbox" disabled  /> Expire passwords after a certain amount of time
                  <ul class="list-bullet">
                    <li>This isn&#39;t recommended practice but some enterprise clients require this in order to sign with you.</li>
                  </ul>                </li>
                <li><input type="checkbox" disabled  /> Passkeys
                  <ul class="list-bullet">
                    <li><a href="https://passkeys.dev/">https://passkeys.dev/</a></li>
                    <li><a href="https://github.com/1Password/passkey-rs">https://github.com/1Password/passkey-rs</a></li>
                  </ul>                </li>
                <li><input type="checkbox" disabled  /> Authenticator app</li>
                <li><input type="checkbox" disabled  /> Authenticator Account recovery codes</li>
                <li><input type="checkbox" disabled  /> Email-based user verification</li>
                <li><input type="checkbox" disabled  /> Account self-deletion</li>
                <li><input type="checkbox" disabled  /> Optional TOS acceptance at registration</li>
                <li><input type="checkbox" disabled  /> Service accounts</li>
                <li><input type="checkbox" disabled  /> Record info about sessions (geoip, user-agent, etc.)</li>
                <li><input type="checkbox" disabled  /> Allow logging out other sessions</li>
              </ul>            </li>
            <li>Permissions
              <ul class="list-bullet">
                <li><input type="checkbox" disabled  /> For models with global permissions, add permissions check in route layer before hitting database</li>
                <li><input type="checkbox" disabled  /> <a class="block-ref" href="/notes/projects_filigree#657a981d-8503-427b-a6ab-319c7879b94c">Project-based Access Control</a></li>
                <li><input type="checkbox" disabled  /> API Key lookup query needs to change to make permissions a subset of the user&#39;s permissions when inherit<em class="italic">user</em>permissions is false</li>
                <li><input type="checkbox" disabled  /> Feature flags</li>
                <li><input type="checkbox" disabled  /> Add &quot;all&quot; model permissions so that some roles have permissions on everything even when new models are added.
                  <ul class="list-bullet">
                    <li>This needs some more thought though. Some models like user, org, etc don&#39;t want to have this blanket rule applied.</li>
                  </ul>                </li>
              </ul>            </li>
            <li>Block Storage
              <ul class="list-bullet">
                <li><input type="checkbox" disabled  /> Block storage abstraction
                  <ul class="list-bullet">
                    <li>revisit opendal vs. object_store crates</li>
                  </ul>                </li>
                <li><input type="checkbox" disabled  /> Block storage: Make it easy to return an object as a Response body</li>
                <li><input type="checkbox" disabled  /> Block storage: Option for Uploads via signed URL</li>
              </ul>            </li>
            <li>Workers
              <ul class="list-bullet">
                <li><input type="checkbox" disabled  /> Define background jobs and generate a helper to enqueue one</li>
                <li><input type="checkbox" disabled  /> Outbox pattern support for running background jobs</li>
                <li><input type="checkbox" disabled  /> Define scheduled tasks that run a job on a cron schedule</li>
              </ul>            </li>
            <li>Notifications
              <ul class="list-bullet">
                <li><input type="checkbox" disabled  /> Notifications: Other types of notifications?</li>
                <li><input type="checkbox" disabled  /> Notifications Internal notifications
                  <ul class="list-bullet">
                    <li>e.g. Discord webhook notifying myself about events</li>
                    <li>This should have notification templates and also destinations for the notifications</li>
                  </ul>                </li>
                <li><input type="checkbox" disabled  /> Email template system</li>
              </ul>            </li>
            <li><input type="checkbox" disabled  /> Bootstrap the real database from fixtures? Maybe not, this is simpler to do in code and tie in to the &quot;new org&quot; code.</li>
            <li><input type="checkbox" disabled  /> Generate Typescript interfaces and JS code to talk to the API</li>
            <li><input type="checkbox" disabled  /> Easy setup for commercialization</li>
            <li><input type="checkbox" disabled  /> Collect and export metrics to some tool
              <ul class="list-bullet">
                <li>Looks like Honeycomb supports Prometheus format</li>
              </ul>            </li>
            <li><input type="checkbox" disabled  /> Delete log table for possibility of undelete later</li>
            <li><input type="checkbox" disabled  /> Option for auditing on all operations</li>
            <li><input type="checkbox" disabled  /> Ability for admins to assume permissions of other users
              <ul class="list-bullet">
                <li>This needs to be audited as well even if nothing else is audited</li>
              </ul>            </li>
            <li><input type="checkbox" disabled  /> Password confirmation flow for &quot;dangerous&quot; actions</li>
            <li><input type="checkbox" disabled  /> User profile photos</li>
          </ul>        </li>
        <li><h3>Done</h3>
          <ul class="list-bullet">
            <li><input type="checkbox" disabled checked /> Generate fixtures for tests &mdash; Jan 5th, 2024</li>
            <li><input type="checkbox" disabled checked /> Write functions needed to bootstrap test data &mdash; Jan 4th, 2024
              <ul class="list-bullet">
                <li>These should basically be the version that the actual app will use, just deferring all the surrounding functionality that isn&#39;t needed to write basic tests</li>
                <li>Add org</li>
                <li>Add roles</li>
                <li>Add user to org with roles/permissions</li>
                <li>Add new org (using all the above)</li>
                <li>Add API key for user</li>
              </ul>            </li>
            <li><input type="checkbox" disabled checked /> Password login/logout endpoints &mdash; Dec 29th, 2023</li>
            <li><input type="checkbox" disabled checked /> Get server to start &mdash; Dec 27th, 2023</li>
            <li><input type="checkbox" disabled checked /> Add permissions checks to endpoints &mdash; Dec 27th, 2023</li>
            <li><input type="checkbox" disabled checked /> Add app-specific AuthInfo object &mdash; Dec 23rd, 2023</li>
            <li><input type="checkbox" disabled checked /> Add AuthQueries implementation &mdash; Dec 23rd, 2023</li>
            <li><input type="checkbox" disabled checked /> Select queries need to return the current permission level on each object for project/object-level permissions &mdash; Dec 22nd, 2023</li>
            <li><input type="checkbox" disabled checked /> Make more files &quot;generated once&quot; &mdash; Dec 22nd, 2023
              <ul class="list-bullet">
                <li>endpoints should only be generated once, and should always be generated even if they are disabled</li>
                <li>Move files that are regenerated to &quot;generated&quot; subdir</li>
              </ul>            </li>
            <li><input type="checkbox" disabled checked /> Add middleware layer to do permissions check &mdash; Dec 22nd, 2023</li>
            <li><input type="checkbox" disabled checked /> Add authz middleware to do generic predicate check &mdash; Dec 22nd, 2023</li>
            <li><input type="checkbox" disabled checked /> query to load user/roles/org for auth info &mdash; Dec 21st, 2023</li>
            <li><input type="checkbox" disabled checked /> Generate router for all model endpoints &mdash; Dec 21st, 2023</li>
            <li><input type="checkbox" disabled checked /> Create endpoints for the model &mdash; Dec 20th, 2023</li>
            <li><input type="checkbox" disabled checked /> Bearer token auth middleware &mdash; Dec 20th, 2023</li>
            <li><input type="checkbox" disabled checked /> Session cookie auth middleware &mdash; Dec 20th, 2023</li>
            <li><input type="checkbox" disabled checked /> Figure out querystring filter parameters &mdash; Dec 18th, 2023</li>
            <li><input type="checkbox" disabled checked /> Pagination &mdash; Dec 18th, 2023</li>
            <li><input type="checkbox" disabled checked /> Rename team to organization</li>
            <li><input type="checkbox" disabled checked /> Create Rust structures for each model</li>
            <li><input type="checkbox" disabled checked /> Bootstrap CLI utility</li>
            <li><input type="checkbox" disabled checked /> Figure out main config format</li>
            <li><input type="checkbox" disabled checked /> Figure out model definition</li>
            <li><input type="checkbox" disabled checked /> Create team, user, role, permissions, etc. tables</li>
            <li><input type="checkbox" disabled checked /> Create SQL migration</li>
            <li><input type="checkbox" disabled checked /> Create SQL queries to read/write the model</li>
          </ul>        </li>
      </ul>    </li>
    <li>This should be made modular somehow so it&#39;s easy to maintain and add new stuff.
      <ul class="list-bullet">
        <li>Modules define dependencies</li>
      </ul>    </li>
    <li>Config
      <ul class="list-bullet">
        <li>formatters to use</li>
        <li>SQL dialect (postgres or sqlite)</li>
      </ul>    </li>
    <li>Model definition
      <ul class="list-bullet">
        <li>Write in TOML</li>
        <li>Each field has
          <ul class="list-bullet">
            <li>SQL type</li>
            <li>nullable (default not null)</li>
            <li>Rust type (can be inferred from the SQL type, but can be overridden)</li>
          </ul>        </li>
        <li>Define Indexes and primary key
          <ul class="list-bullet">
            <li>indexes can maybe just be defined in raw sql</li>
          </ul>        </li>
        <li>Can have child relationships, one -to-one and one-to-many</li>
        <li>Can have JSON fields, which deserialize to either JSON values or other Rust structs
          <ul class="list-bullet">
            <li>The rust structs can be defined in the config as strings or something like that</li>
          </ul>        </li>
        <li>List of other query functions to generate (find by field, etc.)</li>
        <li>Permissions
          <ul class="list-bullet">
            <li>Automatic checking on all operations</li>
            <li>Ability to define which permissions are needed for what</li>
          </ul>        </li>
        <li>some kind of hook on update? or is this better done by just changing the generated code myself</li>
      </ul>    </li>
    <li>Consider some kind of codegen for even easier crud endpoint generation
      <ul class="list-bullet">
        <li>Need ability to generate migrations that add/remove columns too
          <ul class="list-bullet">
            <li>this can definitely be manual to start though.</li>
          </ul>        </li>
      </ul>    </li>
    <li>Authentication
      <ul class="list-bullet">
        <li>Need a user/account mapping to support multiple auth methods per user.</li>
      </ul>    </li>
    <li>Authorization
      <ul class="list-bullet">
        <li>Concepts
          <ul class="list-bullet">
            <li>Organization</li>
            <li>User
              <ul class="list-bullet">
                <li>Users can potentially be in multiple organizations</li>
              </ul>            </li>
            <li>Role
              <ul class="list-bullet">
                <li>Basically a collection of permissions</li>
              </ul>            </li>
            <li>Group
              <ul class="list-bullet">
                <li>This is similar to Role</li>
                <li>Might not do this, but it can be useful to make this different when more advanced sharing options are created.</li>
              </ul>            </li>
            <li>Actor - all the things (users, roles, groups) that can have permissions on objects
              <ul class="list-bullet">
                <li>When looking at permissions we gather up all the actors that apply to the current user, and use that whole list for permissions checks</li>
              </ul>            </li>
          </ul>        </li>
        <li>The permissions table is then a list of the permissions each actor has.</li>
        <li>Permissions
          <ul class="list-bullet">
            <li>These should be definable per model once more than one is supported.</li>
            <li>Tables
              <ul class="list-bullet">
                <li>Global permissions
                  <ul class="list-bullet">
                    <li>A many-to-many mapping of actor to permission</li>
                  </ul>                </li>
                <li>Object permissions
                  <ul class="list-bullet">
                    <li>A mapping of actor to object and permission</li>
                    <li>For a project-based model, the projects are also just objects</li>
                  </ul>                </li>
              </ul>            </li>
            <li>Models
              <ul class="list-bullet">
                <li>Role-based Access Control (RBAC)
                  <ul class="list-bullet">
                    <li>Each role has permissions on whether it can read/write/admin certain types of objects.</li>
                    <li>This is the first one we&#39;ll support</li>
                    <li>Might be useful to have two sets of roles, some which can have the global permissions and are only created by administrators, and others which are generic groups of people for managing sharing of projects and objects
                      <ul class="list-bullet">
                        <li>Need to think about how much this needs to be in the data model vs. just something in the UI. Probably just a single boolean flag is sufficient.</li>
                      </ul>                    </li>
                  </ul>                </li>
                <li>Resource-based access control
                  <ul class="list-bullet">
                    <li>Read/write/admin on individual objects</li>
                    <li>Each role/user has specific permissions for each object</li>
                    <li>More complex, need to make sure the relevant entries get added for each object when it is created</li>
                    <li>Best for a model where objects are not shared by default.</li>
                  </ul>                </li>
                <li id="657a981d-8503-427b-a6ab-319c7879b94c">Project-based Access Control
                  <ul class="list-bullet">
                    <li>This combines with the above concepts but is a middle level of granularity compared to the all-or-nothing of plain RBAC and the often-overly-granular resource-based system.</li>
                    <li>A project acts as a container for objects, and actors can have permissions on the project instead of the individual objects.</li>
                    <li>Will probably implement this after RBAC, just need additional functionality for project management and ability to</li>
                    <li>Both individuals and roles can be added to projects</li>
                  </ul>                </li>
                <li>Attribute-based Access Control (ABAC)
                  <ul class="list-bullet">
                    <li>Objects have attributes and actors</li>
                  </ul>                </li>
                <li>Public sharing
                  <ul class="list-bullet">
                    <li>Some sites are built around publicly sharing your stuff.</li>
                    <li>This is basically the same as the resource-based access control model, but with the ability to share with an &quot;anyone&quot; user, and then all the permissions checks check for that actor ID as well.</li>
                  </ul>                </li>
              </ul>            </li>
            <li>Types of default permissions
              <ul class="list-bullet">
                <li>creator only until shared</li>
                <li>Creator gets write access, everyone else gets read access</li>
                <li>everyone can see, only creator can write</li>
                <li>Everyone in the project can see</li>
                <li>Everyone in the project can edit</li>
              </ul>            </li>
          </ul>        </li>
      </ul>    </li>
    <li>Pricing Plan Support
      <ul class="list-bullet">
        <li>Add pricing tiers and permissions that go along with those tiers - this should mostly be data driven
          <ul class="list-bullet">
            <li>Need ability for numeric values as well (e.g. max 3 projects, 500MB storage, up to 60 minutes of something, etc.)</li>
          </ul>        </li>
        <li>Need ability to do grandfathering of pricing tiers and permissions
          <ul class="list-bullet">
            <li>Essentially this means that both price plans and permissions sets should be versioned, and separately.</li>
            <li>And there should be the ability to update existing plans and all previous versions</li>
          </ul>        </li>
      </ul>    </li>
  </ul>

