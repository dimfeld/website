---
title: "Lateral Joins"
tags: database, SQL
date: 2020-11-23
updated: 2023-02-10
---


  <ul class="list-bullet">
    <li> <a href="/notes/sql">SQL</a> </li>
    <li>Technique in <a href="/notes/sql">SQL</a> for having a subquery in a join that can reference variables from the outer query.</li>
    <li>Most useful when aggregating over things in the subquery to produce an array of results, without needing to group by which is especially inconvenient when aggregating multiple independent joins.</li>
    <li>This example from <a href="https://jawj.github.io/zapatos/">Zapatos</a> gets a single associated author and multiple associated tags for each book.
      <ul class="list-bullet">
        <li><pre><code><span class="sy-source sy-sql"><span class="sy-keyword sy-other sy-DML sy-sql">SELECT</span> coalesce(jsonb_agg(result), <span class="sy-string sy-quoted sy-single sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&#39;</span>[]<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&#39;</span></span>) <span class="sy-keyword sy-other sy-alias sy-sql">AS</span> result
<span class="sy-keyword sy-other sy-DML sy-sql">FROM</span> (
  <span class="sy-keyword sy-other sy-DML sy-sql">SELECT</span> to_jsonb (<span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>books<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>.<span class="sy-keyword sy-operator sy-star sy-sql">*</span>) <span class="sy-keyword sy-operator sy-concatenator sy-sql">||</span> jsonb_build_object($<span class="sy-constant sy-numeric sy-sql">1</span>::<span class="sy-storage sy-type sy-sql">text</span>, <span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>ljoin_0<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>.result, $<span class="sy-constant sy-numeric sy-sql">2</span>::<span class="sy-storage sy-type sy-sql">text</span>, <span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>ljoin_1<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>.result) <span class="sy-keyword sy-other sy-alias sy-sql">AS</span> result
  <span class="sy-keyword sy-other sy-DML sy-sql">FROM</span> <span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>books<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>
  <span class="sy-keyword sy-other sy-DML sy-sql">LEFT JOIN</span> LATERAL (
    <span class="sy-keyword sy-other sy-DML sy-sql">SELECT</span> to_jsonb (<span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>authors<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>.<span class="sy-keyword sy-operator sy-star sy-sql">*</span>) <span class="sy-keyword sy-other sy-alias sy-sql">AS</span> result
    <span class="sy-keyword sy-other sy-DML sy-sql">FROM</span> <span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>authors<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>
    <span class="sy-keyword sy-other sy-DML sy-sql">WHERE</span> (<span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>id<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span> <span class="sy-keyword sy-operator sy-comparison sy-sql">=</span> <span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>books<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>.<span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>authorId<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>)
    <span class="sy-keyword sy-other sy-DML sy-sql">LIMIT</span> $<span class="sy-constant sy-numeric sy-sql">3</span>) <span class="sy-keyword sy-other sy-alias sy-sql">AS</span> <span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>ljoin_0<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span> <span class="sy-keyword sy-other sy-DDL sy-create sy-II sy-sql">ON</span> <span class="sy-constant sy-boolean sy-sql">true</span>
  <span class="sy-keyword sy-other sy-DML sy-sql">LEFT JOIN</span> LATERAL (
    <span class="sy-keyword sy-other sy-DML sy-sql">SELECT</span> coalesce(jsonb_agg(result), <span class="sy-string sy-quoted sy-single sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&#39;</span>[]<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&#39;</span></span>) <span class="sy-keyword sy-other sy-alias sy-sql">AS</span> result
    <span class="sy-keyword sy-other sy-DML sy-sql">FROM</span> (
      <span class="sy-keyword sy-other sy-DML sy-sql">SELECT</span> to_jsonb (<span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>tags<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>.<span class="sy-keyword sy-operator sy-star sy-sql">*</span>) <span class="sy-keyword sy-other sy-alias sy-sql">AS</span> result
      <span class="sy-keyword sy-other sy-DML sy-sql">FROM</span> <span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>tags<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>
      <span class="sy-keyword sy-other sy-DML sy-sql">WHERE</span> (<span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>bookId<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span> <span class="sy-keyword sy-operator sy-comparison sy-sql">=</span> <span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>books<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>.<span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>id<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>)) <span class="sy-keyword sy-other sy-alias sy-sql">AS</span> <span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>sq_tags<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>) <span class="sy-keyword sy-other sy-alias sy-sql">AS</span> <span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>ljoin_1<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span> <span class="sy-keyword sy-other sy-DDL sy-create sy-II sy-sql">ON</span> <span class="sy-constant sy-boolean sy-sql">true</span>
)
<span class="sy-keyword sy-other sy-alias sy-sql">AS</span> <span class="sy-string sy-quoted sy-double sy-sql"><span class="sy-punctuation sy-definition sy-string sy-begin sy-sql">&quot;</span>sq_books<span class="sy-punctuation sy-definition sy-string sy-end sy-sql">&quot;</span></span>
</span></code></pre></li>
      </ul>    </li>
  </ul>

