---
title: "Lateral Joins"
tags: database, SQL
date: 2020-11-23
updated: 2020-11-23
---


  <ul class="list-bullet">
    <li> <a href="/notes/sql">SQL</a> </li>
    <li>Technique in <a href="/notes/sql">SQL</a> for having a subquery in a join that can reference variables from the outer query. </li>
    <li>Most useful when aggregating over things in the subquery to produce an array of results, without needing to group by which is especially inconvenient when aggregating multiple independent joins.</li>
    <li>This example from <a href="https://jawj.github.io/zapatos/">Zapatos</a> gets a single associated author and multiple associated tags for each book.
      <ul class="list-bullet">
        <li>
<pre><code><span class="hljs-source hljs-sql"><span class="hljs-keyword hljs-other hljs-DML hljs-sql">SELECT</span> coalesce(jsonb_agg(result), <span class="hljs-string hljs-quoted hljs-single hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&#39;</span>[]<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&#39;</span></span>) <span class="hljs-keyword hljs-other hljs-alias hljs-sql">AS</span> result
<span class="hljs-keyword hljs-other hljs-DML hljs-sql">FROM</span> (
<span class="hljs-keyword hljs-other hljs-DML hljs-sql">SELECT</span> to_jsonb (<span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>books<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>.<span class="hljs-keyword hljs-operator hljs-star hljs-sql">*</span>) <span class="hljs-keyword hljs-operator hljs-concatenator hljs-sql">||</span> jsonb_build_object($<span class="hljs-constant hljs-numeric hljs-sql">1</span>::<span class="hljs-storage hljs-type hljs-sql">text</span>, <span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>ljoin_0<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>.result, $<span class="hljs-constant hljs-numeric hljs-sql">2</span>::<span class="hljs-storage hljs-type hljs-sql">text</span>, <span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>ljoin_1<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>.result) <span class="hljs-keyword hljs-other hljs-alias hljs-sql">AS</span> result
<span class="hljs-keyword hljs-other hljs-DML hljs-sql">FROM</span> <span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>books<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>
<span class="hljs-keyword hljs-other hljs-DML hljs-sql">LEFT JOIN</span> LATERAL (
  <span class="hljs-keyword hljs-other hljs-DML hljs-sql">SELECT</span> to_jsonb (<span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>authors<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>.<span class="hljs-keyword hljs-operator hljs-star hljs-sql">*</span>) <span class="hljs-keyword hljs-other hljs-alias hljs-sql">AS</span> result
  <span class="hljs-keyword hljs-other hljs-DML hljs-sql">FROM</span> <span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>authors<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>
  <span class="hljs-keyword hljs-other hljs-DML hljs-sql">WHERE</span> (<span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>id<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span> <span class="hljs-keyword hljs-operator hljs-comparison hljs-sql">=</span> <span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>books<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>.<span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>authorId<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>)
<span class="hljs-keyword hljs-other hljs-DML hljs-sql">LIMIT</span> $<span class="hljs-constant hljs-numeric hljs-sql">3</span>) <span class="hljs-keyword hljs-other hljs-alias hljs-sql">AS</span> <span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>ljoin_0<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span> <span class="hljs-keyword hljs-other hljs-DDL hljs-create hljs-II hljs-sql">ON</span> <span class="hljs-constant hljs-boolean hljs-sql">true</span>
<span class="hljs-keyword hljs-other hljs-DML hljs-sql">LEFT JOIN</span> LATERAL (
  <span class="hljs-keyword hljs-other hljs-DML hljs-sql">SELECT</span> coalesce(jsonb_agg(result), <span class="hljs-string hljs-quoted hljs-single hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&#39;</span>[]<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&#39;</span></span>) <span class="hljs-keyword hljs-other hljs-alias hljs-sql">AS</span> result
  <span class="hljs-keyword hljs-other hljs-DML hljs-sql">FROM</span> (
    <span class="hljs-keyword hljs-other hljs-DML hljs-sql">SELECT</span> to_jsonb (<span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>tags<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>.<span class="hljs-keyword hljs-operator hljs-star hljs-sql">*</span>) <span class="hljs-keyword hljs-other hljs-alias hljs-sql">AS</span> result
    <span class="hljs-keyword hljs-other hljs-DML hljs-sql">FROM</span> <span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>tags<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>
    <span class="hljs-keyword hljs-other hljs-DML hljs-sql">WHERE</span> (<span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>bookId<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span> <span class="hljs-keyword hljs-operator hljs-comparison hljs-sql">=</span> <span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>books<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>.<span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>id<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>)) <span class="hljs-keyword hljs-other hljs-alias hljs-sql">AS</span> <span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>sq_tags<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>) <span class="hljs-keyword hljs-other hljs-alias hljs-sql">AS</span> <span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>ljoin_1<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span> <span class="hljs-keyword hljs-other hljs-DDL hljs-create hljs-II hljs-sql">ON</span> <span class="hljs-constant hljs-boolean hljs-sql">true</span>) <span class="hljs-keyword hljs-other hljs-alias hljs-sql">AS</span> <span class="hljs-string hljs-quoted hljs-double hljs-sql"><span class="hljs-punctuation hljs-definition hljs-string hljs-begin hljs-sql">&quot;</span>sq_books<span class="hljs-punctuation hljs-definition hljs-string hljs-end hljs-sql">&quot;</span></span>
</span></code></pre></li>
      </ul>    </li>
  </ul>

