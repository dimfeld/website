---
title: "Using WebSockets with SvelteKit"
tags: Svelte
date: 2023-10-08
updated: 2023-10-08
draft: true
---


    
    <p>SvelteKit has extensive functionality, but has not yet incorporated support for WebSockets. Native support is currently being discussed on a <a href="https://github.com/sveltejs/kit/issues/1491">Github issue</a>, but in the meantime there are still ways to do it.</p>
    <p>This post will cover integrating WebSockets into a SvelteKit application, along with a few wrinkles that I haven&#39;t seen mentioned elsewhere.</p>
    <p>Please note that the directions for production builds in this guide are for running Node.js with <code>adapter-node</code>. Directions for other platforms that support WebSockets may be similar, but will likely differ in some way.</p>
    <h2>Server Setup</h2>
        <p>For the server side, we need to create a WebSocket server, and then attach it into the HTTP server. We need different code to accomplish this when running in development with Vite or with a production build, but most of the code is shared between the two.</p>
        <h3>Create the Server</h3>
            <p>First, we&#39;ll install the <code>ws</code> package to provide WebSocket support. We also install <code>bufferutil</code>, which <code>ws</code> can use to help accelerate WebSocket protocol operations.</p>
            <pre><code><span class="sy-text sy-plain">pnpm add ws bufferutil
pnpm add -D @types/ws
</span></code></pre>
            <p>With that done, we can create the server. We place the server in the global namespace at a well-known key, so that later we can access it from both the Vite configuration and the application code and ensure that everything is referencing the same instance.</p>
            <pre><code><span class="sy-source sy-ts"><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> src/lib/server/ws_node.ts</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">WebSocketServer</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>ws<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

<span class="sy-meta sy-var sy-expr sy-ts"><span class="sy-storage sy-type sy-ts">const</span> <span class="sy-meta sy-var-single-variable sy-expr sy-ts"><span class="sy-meta sy-definition sy-variable sy-ts"><span class="sy-variable sy-other sy-constant sy-ts">wsServerKey</span></span> </span><span class="sy-keyword sy-operator sy-assignment sy-ts">=</span> <span class="sy-meta sy-function-call sy-ts"><span class="sy-support sy-class sy-builtin sy-ts">Symbol</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">for</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>app.wsServer<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

<span class="sy-meta sy-type sy-declaration sy-ts"><span class="sy-storage sy-type sy-type sy-ts">type</span> <span class="sy-entity sy-name sy-type sy-alias sy-ts">Global</span> <span class="sy-keyword sy-operator sy-assignment sy-ts">=</span> <span class="sy-keyword sy-operator sy-expression sy-typeof sy-ts">typeof</span> <span class="sy-variable sy-other sy-readwrite sy-ts">globalThis</span> <span class="sy-keyword sy-operator sy-type sy-ts">&amp;</span> <span class="sy-meta sy-object sy-type sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
<span class="sy-meta sy-field sy-declaration sy-ts"><span class="sy-meta sy-array sy-literal sy-ts">  <span class="sy-meta sy-brace sy-square sy-ts">[</span><span class="sy-variable sy-other sy-readwrite sy-ts">wsServerKey</span><span class="sy-meta sy-brace sy-square sy-ts">]</span></span><span class="sy-meta sy-type sy-annotation sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">WebSocketServer</span> <span class="sy-keyword sy-operator sy-type sy-ts">|</span> <span class="sy-support sy-type sy-builtin sy-ts">undefined</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

<span class="sy-meta sy-function sy-ts"><span class="sy-keyword sy-control sy-export sy-ts">export</span> <span class="sy-storage sy-type sy-function sy-ts">function</span> <span class="sy-meta sy-definition sy-function sy-ts"><span class="sy-entity sy-name sy-function sy-ts">getWebsocketServer</span></span><span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span><span class="sy-meta sy-return sy-type sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">WebSocketServer</span> </span><span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
  <span class="sy-meta sy-var sy-expr sy-ts"><span class="sy-storage sy-type sy-ts">const</span> <span class="sy-meta sy-var-single-variable sy-expr sy-ts"><span class="sy-meta sy-definition sy-variable sy-ts"><span class="sy-variable sy-other sy-constant sy-ts">existing</span></span> </span><span class="sy-keyword sy-operator sy-assignment sy-ts">=</span> <span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-variable sy-other sy-readwrite sy-ts">globalThis</span> <span class="sy-keyword sy-control sy-as sy-ts">as</span> <span class="sy-entity sy-name sy-type sy-ts">Global</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-meta sy-array sy-literal sy-ts"><span class="sy-meta sy-brace sy-square sy-ts">[</span><span class="sy-variable sy-other sy-readwrite sy-ts">wsServerKey</span><span class="sy-meta sy-brace sy-square sy-ts">]</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-keyword sy-control sy-conditional sy-ts">if</span> <span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-variable sy-other sy-readwrite sy-ts">existing</span><span class="sy-meta sy-brace sy-round sy-ts">)</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
    <span class="sy-keyword sy-control sy-flow sy-ts">return</span> <span class="sy-variable sy-other sy-readwrite sy-ts">existing</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span>

  <span class="sy-meta sy-var sy-expr sy-ts"><span class="sy-storage sy-type sy-ts">const</span> <span class="sy-meta sy-var-single-variable sy-expr sy-ts"><span class="sy-meta sy-definition sy-variable sy-ts"><span class="sy-variable sy-other sy-constant sy-ts">wsServer</span></span> </span><span class="sy-keyword sy-operator sy-assignment sy-ts">=</span> <span class="sy-new sy-expr sy-ts"><span class="sy-keyword sy-operator sy-new sy-ts">new</span> <span class="sy-meta sy-function-call sy-ts"><span class="sy-entity sy-name sy-function sy-ts">WebSocketServer</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-meta sy-objectliteral sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
    <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">noServer</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span> <span class="sy-constant sy-language sy-boolean sy-true sy-ts">true</span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
    <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">path</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>/ws<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
  <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

  <span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-variable sy-other sy-readwrite sy-ts">globalThis</span> <span class="sy-keyword sy-control sy-as sy-ts">as</span> <span class="sy-entity sy-name sy-type sy-ts">Global</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-meta sy-array sy-literal sy-ts"><span class="sy-meta sy-brace sy-square sy-ts">[</span><span class="sy-variable sy-other sy-readwrite sy-ts">wsServerKey</span><span class="sy-meta sy-brace sy-square sy-ts">]</span></span> <span class="sy-keyword sy-operator sy-assignment sy-ts">=</span> <span class="sy-variable sy-other sy-readwrite sy-ts">wsServer</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

  <span class="sy-keyword sy-control sy-flow sy-ts">return</span> <span class="sy-variable sy-other sy-readwrite sy-ts">wsServer</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span>
</span></code></pre>
            <p>We pass two arguments to the WebSocketServer. <code>noServer: true</code> tells it to not start its own full HTTP server, since we&#39;ll be using the server started by Vite or <code>adapter-node</code>.</p>
            <p>The <code>path</code> argument is optional, and indicates that this server should only handle WebSocket requests for the <code>/ws</code> path.</p>

        <h3>Handle the Connection</h3>
            <p>A WebSocket connection request starts with a normal HTTP 1.1 request that includes the <code>upgrade</code> header to indicate that it would like a WebSocket connection. Node&#39;s built-in HTTP server doesn&#39;t do anything with this by default, but it does let us detect an upgrade and route it to our WebSocketServer. The handler can be added to the above <code>ws_node.ts</code> file, and looks like this.</p>
            <pre><code><span class="sy-source sy-ts"><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> src/lib/server/ws_node.ts, continued</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-keyword sy-control sy-type sy-ts">type</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">IncomingMessage</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>http<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-keyword sy-control sy-type sy-ts">type</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">Duplex</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>stream<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

<span class="sy-meta sy-function sy-ts"><span class="sy-keyword sy-control sy-export sy-ts">export</span> <span class="sy-storage sy-type sy-function sy-ts">function</span> <span class="sy-meta sy-definition sy-function sy-ts"><span class="sy-entity sy-name sy-function sy-ts">handleWsUpgrade</span></span><span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span>
	<span class="sy-variable sy-parameter sy-ts">req</span><span class="sy-meta sy-type sy-annotation sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">IncomingMessage</span></span><span class="sy-punctuation sy-separator sy-parameter sy-ts">,</span> <span class="sy-variable sy-parameter sy-ts">sock</span><span class="sy-meta sy-type sy-annotation sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">Duplex</span></span><span class="sy-punctuation sy-separator sy-parameter sy-ts">,</span> <span class="sy-variable sy-parameter sy-ts">head</span><span class="sy-meta sy-type sy-annotation sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">Buffer</span></span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
  <span class="sy-meta sy-var sy-expr sy-ts"><span class="sy-storage sy-type sy-ts">const</span> <span class="sy-meta sy-var-single-variable sy-expr sy-ts"><span class="sy-meta sy-definition sy-variable sy-ts"><span class="sy-variable sy-other sy-constant sy-ts">wsServer</span></span> </span><span class="sy-keyword sy-operator sy-assignment sy-ts">=</span> <span class="sy-meta sy-function-call sy-ts"><span class="sy-entity sy-name sy-function sy-ts">getWebsocketServer</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-meta sy-brace sy-round sy-ts">)</span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-keyword sy-control sy-conditional sy-ts">if</span> <span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">wsServer</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">shouldHandle</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-variable sy-other sy-readwrite sy-ts">req</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-meta sy-brace sy-round sy-ts">)</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
    <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">wsServer</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">emit</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>handleUpgrade<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-ts">req</span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-ts">sock</span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-ts">head</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span>
<span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span>

</span></code></pre>
            <p>The <code>wsServer.shouldHandle</code> function just checks if the current request&#39;s URL matches the one we passed when creating the WebSocketServer. You can also implement this URL check manually if you want, but either way it is necessary, since Vite&#39;s development server also uses its own WebSocket, and we want to make sure that our code does not try to handle that.</p>
            <p>Most example code calls <code>wsServer.handleUpgrade</code> here and then emits an event with the WebSocket connection. We do it slightly differently, emitting the event before the upgrade, but with all the necessary information to perform it. This allows our code to perform additional authentication checks before setting up the WebSocket if desired, but without requiring this file to import regular application code.</p>
            <p>Importing application code from here causes problems in development because the file will be imported when Vite builds its configuration, before the SvelteKit Vite plugin has initialized to make <code>$app</code>, <code>$env</code>, and similar import paths work. There are also other potential issues in production with duplicated code. So this bit of indirection makes everything work better.</p>
            <p>Thus our upgrade handler&#39;s only task is to emit an event and pass the upgrade processing elsewhere, which we&#39;ll implement now.</p>
            <pre><code><span class="sy-source sy-ts"><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> src/lib/server/ws.ts</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-keyword sy-control sy-type sy-ts">type</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">IncomingMessage</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>http<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-keyword sy-control sy-type sy-ts">type</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">WebSocket</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>ws<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">getWebsocketServer</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>./ws_node<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

<span class="sy-meta sy-function sy-ts"><span class="sy-storage sy-modifier sy-async sy-ts">async</span> <span class="sy-storage sy-type sy-function sy-ts">function</span> <span class="sy-meta sy-definition sy-function sy-ts"><span class="sy-entity sy-name sy-function sy-ts">handleUpgrade</span></span><span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span>
  <span class="sy-variable sy-parameter sy-ts">req</span><span class="sy-meta sy-type sy-annotation sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">IncomingMessage</span></span><span class="sy-punctuation sy-separator sy-parameter sy-ts">,</span>
  <span class="sy-variable sy-parameter sy-ts">sock</span><span class="sy-meta sy-type sy-annotation sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">Duplex</span></span><span class="sy-punctuation sy-separator sy-parameter sy-ts">,</span>
  <span class="sy-variable sy-parameter sy-ts">head</span><span class="sy-meta sy-type sy-annotation sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">Buffer</span>
</span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
<span class="sy-punctuation sy-whitespace sy-comment sy-leading sy-ts">  </span><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> Optional auth check if your app needs it</span>
  <span class="sy-meta sy-var sy-expr sy-ts"><span class="sy-storage sy-type sy-ts">let</span> <span class="sy-meta sy-var-single-variable sy-expr sy-ts"><span class="sy-meta sy-definition sy-variable sy-ts"><span class="sy-variable sy-other sy-readwrite sy-ts">user</span></span> <span class="sy-meta sy-type sy-annotation sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">User</span></span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-keyword sy-control sy-trycatch sy-ts">try</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
  	<span class="sy-variable sy-other sy-readwrite sy-ts">user</span> <span class="sy-keyword sy-operator sy-assignment sy-ts">=</span> <span class="sy-keyword sy-control sy-flow sy-ts">await</span> <span class="sy-meta sy-function-call sy-ts"><span class="sy-entity sy-name sy-function sy-ts">authenticate</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-variable sy-other sy-readwrite sy-ts">req</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-trycatch sy-ts">catch</span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-variable sy-other sy-readwrite sy-ts">e</span><span class="sy-meta sy-brace sy-round sy-ts">)</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span><span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span>
  
  <span class="sy-keyword sy-control sy-conditional sy-ts">if</span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-keyword sy-operator sy-logical sy-ts">!</span><span class="sy-variable sy-other sy-readwrite sy-ts">user</span><span class="sy-meta sy-brace sy-round sy-ts">)</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
<span class="sy-punctuation sy-whitespace sy-comment sy-leading sy-ts">    </span><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> Add a do-nothing error handler just in case the client</span>
<span class="sy-punctuation sy-whitespace sy-comment sy-leading sy-ts">    </span><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> closed the connection already.</span>
    <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">sock</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">on</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>error<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span><span class="sy-meta sy-arrow sy-ts"> <span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span> </span><span class="sy-meta sy-arrow sy-ts"><span class="sy-storage sy-type sy-function sy-arrow sy-ts">=&gt;</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span><span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  
    <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">sock</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-support sy-function sy-dom sy-ts">write</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>HTTP/1.1 401 Unauthorized<span class="sy-constant sy-character sy-escape sy-ts">\r</span><span class="sy-constant sy-character sy-escape sy-ts">\n</span><span class="sy-constant sy-character sy-escape sy-ts">\r</span><span class="sy-constant sy-character sy-escape sy-ts">\n</span><span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
    <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">sock</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">destroy</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
    <span class="sy-keyword sy-control sy-flow sy-ts">return</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span>

<span class="sy-punctuation sy-whitespace sy-comment sy-leading sy-ts">  </span><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> If you don&#39;t need an auth check then you can skip everything above </span>
<span class="sy-punctuation sy-whitespace sy-comment sy-leading sy-ts">  </span><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> and call this right away.</span>
  <span class="sy-meta sy-var sy-expr sy-ts"><span class="sy-storage sy-type sy-ts">const</span> <span class="sy-meta sy-var-single-variable sy-expr sy-ts"><span class="sy-meta sy-definition sy-variable sy-ts"><span class="sy-variable sy-other sy-constant sy-ts">wsServer</span></span> </span><span class="sy-keyword sy-operator sy-assignment sy-ts">=</span> <span class="sy-meta sy-function-call sy-ts"><span class="sy-entity sy-name sy-function sy-ts">getWebsocketServer</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-meta sy-brace sy-round sy-ts">)</span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">wsServer</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">handleUpgrade</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-variable sy-other sy-readwrite sy-ts">req</span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-ts">sock</span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-ts">head</span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span><span class="sy-meta sy-arrow sy-ts"> <span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span><span class="sy-variable sy-parameter sy-ts">ws</span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span> </span><span class="sy-meta sy-arrow sy-ts"><span class="sy-storage sy-type sy-function sy-arrow sy-ts">=&gt;</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
    <span class="sy-meta sy-function-call sy-ts"><span class="sy-entity sy-name sy-function sy-ts">websocketSession</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-variable sy-other sy-readwrite sy-ts">ws</span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-ts">req</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span>
</span></code></pre>
            <p>The <code>handleUpgrade</code> function can perform any checks needed to decide if the request is permitted to create a WebSocket. After that, the WebSocketServer knows how to create the WebSocket, so we call <code>wsServer.handleUpgrade</code>, and then pass control to the actual application logic.</p>
            <pre><code><span class="sy-source sy-ts"><span class="sy-meta sy-function sy-ts"><span class="sy-storage sy-type sy-function sy-ts">function</span> <span class="sy-meta sy-definition sy-function sy-ts"><span class="sy-entity sy-name sy-function sy-ts">websocketSession</span></span><span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span><span class="sy-variable sy-parameter sy-ts">ws</span><span class="sy-meta sy-type sy-annotation sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">WebSocket</span></span><span class="sy-punctuation sy-separator sy-parameter sy-ts">,</span> <span class="sy-variable sy-parameter sy-ts">req</span><span class="sy-meta sy-type sy-annotation sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">IncomingMessage</span></span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
<span class="sy-punctuation sy-whitespace sy-comment sy-leading sy-ts">  </span><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> Your application logic here.</span>
  
  <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">ws</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">on</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>message<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span><span class="sy-meta sy-arrow sy-ts"> <span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span><span class="sy-variable sy-parameter sy-ts">msg</span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span> </span><span class="sy-meta sy-arrow sy-ts"><span class="sy-storage sy-type sy-function sy-arrow sy-ts">=&gt;</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
<span class="sy-punctuation sy-whitespace sy-comment sy-leading sy-ts">    </span><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> handle the message</span>
  <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

  <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">ws</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">on</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>close<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span><span class="sy-meta sy-arrow sy-ts"> <span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span><span class="sy-variable sy-parameter sy-ts">code</span><span class="sy-punctuation sy-separator sy-parameter sy-ts">,</span> <span class="sy-variable sy-parameter sy-ts">reason</span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span> </span><span class="sy-meta sy-arrow sy-ts"><span class="sy-storage sy-type sy-function sy-arrow sy-ts">=&gt;</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
<span class="sy-punctuation sy-whitespace sy-comment sy-leading sy-ts">    </span><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> cleanup</span>
  <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

  <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">ws</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">on</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>error<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span><span class="sy-meta sy-arrow sy-ts"> <span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span><span class="sy-variable sy-parameter sy-ts">err</span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span> </span><span class="sy-meta sy-arrow sy-ts"><span class="sy-storage sy-type sy-function sy-arrow sy-ts">=&gt;</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span><span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

  <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">ws</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-support sy-function sy-ts">send</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-meta sy-function-call sy-ts"><span class="sy-support sy-constant sy-json sy-ts">JSON</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-support sy-function sy-json sy-ts">stringify</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-meta sy-objectliteral sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">hello</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>world<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span> </span><span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span>
</span></code></pre>

        <h3>Connecting the Upgrade Handler</h3>
            <p>Finally, we connect our <code>handleUpgrade</code> function to handle the event, which can be done in any code that will run when the application first starts up. I like <code>hooks.server.ts</code> for this purpose.</p>
            <pre><code><span class="sy-source sy-ts"><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> src/hooks.server.ts</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">building</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>$app/environment<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">getWebsocketServer</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>$lib/server/ws_node<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">handleUpgrade</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>$lib/server/ws<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

<span class="sy-keyword sy-control sy-conditional sy-ts">if</span> <span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-keyword sy-operator sy-logical sy-ts">!</span><span class="sy-variable sy-other sy-readwrite sy-ts">building</span><span class="sy-meta sy-brace sy-round sy-ts">)</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
  <span class="sy-meta sy-var sy-expr sy-ts"><span class="sy-storage sy-type sy-ts">const</span> <span class="sy-meta sy-var-single-variable sy-expr sy-ts"><span class="sy-meta sy-definition sy-variable sy-ts"><span class="sy-variable sy-other sy-constant sy-ts">wsServer</span></span> </span><span class="sy-keyword sy-operator sy-assignment sy-ts">=</span> <span class="sy-meta sy-function-call sy-ts"><span class="sy-entity sy-name sy-function sy-ts">getWebsocketServer</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-meta sy-brace sy-round sy-ts">)</span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">wsServer</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">removeAllListeners</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>handleUpgrade<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">wsServer</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">on</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>handleUpgrade<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-ts">handleUpgrade</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span>

<span class="sy-meta sy-function sy-ts"><span class="sy-keyword sy-control sy-export sy-ts">export</span> <span class="sy-storage sy-type sy-function sy-ts">function</span> <span class="sy-meta sy-definition sy-function sy-ts"><span class="sy-entity sy-name sy-function sy-ts">handle</span></span><span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span><span class="sy-meta sy-parameter sy-object-binding-pattern sy-ts"><span class="sy-punctuation sy-definition sy-binding-pattern sy-object sy-ts">{</span> <span class="sy-variable sy-parameter sy-ts">event</span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-parameter sy-ts">resolve</span> <span class="sy-punctuation sy-definition sy-binding-pattern sy-object sy-ts">}</span></span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
  <span class="sy-keyword sy-control sy-flow sy-ts">return</span> <span class="sy-meta sy-function-call sy-ts"><span class="sy-entity sy-name sy-function sy-ts">resolve</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-support sy-variable sy-dom sy-ts">event</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span>
</span></code></pre>
            <h4>Handling Hot Module Reloading</h4>
                <p>Every time we add our <code>handleUpgrade</code> listener, we first remove all existing listeners first to make hot module reloading (HMR) work properly.</p>
                <p>This is because when you modify any of your server-side WebSocket code, Vite will reload that file and any files that depend on it, which then attaches the new version of the handler function to the <code>handleUpgrade</code> event.</p>
                <p>But the old handler with the old version of the code still remains, and both the old and new functions will try to handle the connection at the same time. This, of course, is unwanted, so removing all the listeners avoids this situation without requiring us to restart Vite. And it&#39;s safe since we know that no other code will be adding event listeners to our WebSocketServer.</p>


        <h3>Setting Up the Development Server</h3>
            <p>Now, we need to actually connect the WebSocketServer to Vite&#39;s HTTP server. This can be done with a small Vite plugin which handles Vite&#39;s <code>configureServer</code> and <code>configurePreviewServer</code> hooks.</p>
            <pre><code><span class="sy-source sy-ts"><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> vite.config.ts</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">sveltekit</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>@sveltejs/kit/vite<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">defineConfig</span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">type</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">PluginOption</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>vite<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">handleWsUpgrade</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>./src/lib/server/ws_node<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

<span class="sy-meta sy-var sy-expr sy-ts"><span class="sy-storage sy-type sy-ts">const</span> <span class="sy-meta sy-var-single-variable sy-expr sy-ts"><span class="sy-meta sy-definition sy-variable sy-ts"><span class="sy-variable sy-other sy-constant sy-ts">wsServer</span></span><span class="sy-meta sy-type sy-annotation sy-ts"><span class="sy-keyword sy-operator sy-type sy-annotation sy-ts">:</span> <span class="sy-entity sy-name sy-type sy-ts">PluginOption</span> </span></span><span class="sy-keyword sy-operator sy-assignment sy-ts">=</span> <span class="sy-meta sy-objectliteral sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
  <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">name</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>websockets<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
<span class="sy-meta sy-method sy-declaration sy-ts">  <span class="sy-meta sy-definition sy-method sy-ts"><span class="sy-entity sy-name sy-function sy-ts">configureServer</span></span><span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span><span class="sy-variable sy-parameter sy-ts">server</span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
    <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">server</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-variable sy-other sy-object sy-property sy-ts">httpServer</span><span class="sy-punctuation sy-accessor sy-optional sy-ts">?.</span><span class="sy-entity sy-name sy-function sy-ts">on</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>upgrade<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-ts">handleWsUpgrade</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
<span class="sy-meta sy-method sy-declaration sy-ts">  <span class="sy-meta sy-definition sy-method sy-ts"><span class="sy-entity sy-name sy-function sy-ts">configurePreviewServer</span></span><span class="sy-meta sy-parameters sy-ts"><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-ts">(</span><span class="sy-variable sy-parameter sy-ts">server</span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-ts">)</span></span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
    <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">server</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-variable sy-other sy-object sy-property sy-ts">httpServer</span><span class="sy-punctuation sy-accessor sy-optional sy-ts">?.</span><span class="sy-entity sy-name sy-function sy-ts">on</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>upgrade<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-ts">handleWsUpgrade</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
  <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
<span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

<span class="sy-meta sy-export sy-default sy-ts"><span class="sy-keyword sy-control sy-export sy-ts">export</span> <span class="sy-keyword sy-control sy-default sy-ts">default</span> <span class="sy-meta sy-function-call sy-ts"><span class="sy-entity sy-name sy-function sy-ts">defineConfig</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-meta sy-objectliteral sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
  <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">plugins</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span><span class="sy-meta sy-array sy-literal sy-ts"> <span class="sy-meta sy-brace sy-square sy-ts">[</span><span class="sy-meta sy-function-call sy-ts"><span class="sy-entity sy-name sy-function sy-ts">sveltekit</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-ts">wsServer</span><span class="sy-meta sy-brace sy-square sy-ts">]</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
<span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
</span></code></pre>

        <h3>Setting Up the Production Server</h3>
            <p>A production build doesn&#39;t use Vite so we need a different solution. Fortunately, <code>adapter-node</code> exports its HTTP server.</p>
            <p>Importing from <code>build/index.js</code> will set up the server just as if the file was run directly, so the only extra thing to do is attaching the upgrade function.</p>
            <pre><code><span class="sy-source sy-ts"><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> src/server.ts</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">handleWsUpgrade</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>./lib/server/ws_node.js<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

<span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> Import from the default adapter-node output file.</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-meta sy-block sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">server</span> <span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>../build/index.js<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

<span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">server</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-variable sy-other sy-object sy-property sy-ts">server</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">on</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>upgrade<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> <span class="sy-variable sy-other sy-readwrite sy-ts">handleWsUpgrade</span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
</span></code></pre>
            <h4>Handling Typescript</h4>
                <p>Under some circumstances you could just run this server, but in this case, <code>ws_node.ts</code> is in Typescript, and Node won&#39;t load it out of the box. Some have recommended using Typescript wrappers such as <code>ts-node</code> or <code>tsm</code> to get around this, but these are not suitable solutions for production use.</p>
                <p>Instead, we can use <code>esbuild</code> to process our <code>server.ts</code> file and everything it imports. I chose <code>esbuild</code> since Vite already depends on it. Note that if you are using <code>pnpm</code> you will still have to explicitly add the dependency using <code>pnpm add -D esbuild</code> or equivalent.</p>
                <p><code>esbuild</code> is just a module that you can import and call, and the main task here is figuring out the right set of options to pass.</p>
                <pre><code><span class="sy-source sy-ts"><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> server.esbuild.mjs</span>
<span class="sy-meta sy-import sy-ts"><span class="sy-keyword sy-control sy-import sy-ts">import</span> <span class="sy-constant sy-language sy-import-export-all sy-ts">*</span> <span class="sy-keyword sy-control sy-as sy-ts">as</span> <span class="sy-variable sy-other sy-readwrite sy-alias sy-ts">esbuild</span> <span class="sy-keyword sy-control sy-from sy-ts">from</span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>esbuild<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>

<span class="sy-keyword sy-control sy-flow sy-ts">await</span> <span class="sy-meta sy-function-call sy-ts"><span class="sy-variable sy-other sy-object sy-ts">esbuild</span><span class="sy-punctuation sy-accessor sy-ts">.</span><span class="sy-entity sy-name sy-function sy-ts">build</span></span><span class="sy-meta sy-brace sy-round sy-ts">(</span><span class="sy-meta sy-objectliteral sy-ts"><span class="sy-punctuation sy-definition sy-block sy-ts">{</span>
  <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">entryPoints</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span><span class="sy-meta sy-array sy-literal sy-ts"> <span class="sy-meta sy-brace sy-square sy-ts">[</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>src/server.ts<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-meta sy-brace sy-square sy-ts">]</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
  <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">bundle</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span> <span class="sy-constant sy-language sy-boolean sy-true sy-ts">true</span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
  <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">outfile</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>server/index.js<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
  <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">platform</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>node<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
  <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">format</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>esm<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
<span class="sy-punctuation sy-whitespace sy-comment sy-leading sy-ts">  </span><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> Don&#39;t bundle dependencies</span>
  <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">packages</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>external<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
<span class="sy-punctuation sy-whitespace sy-comment sy-leading sy-ts">  </span><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> Also don&#39;t bundle the rest of the adapter-node output</span>
  <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">external</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span><span class="sy-meta sy-array sy-literal sy-ts"> <span class="sy-meta sy-brace sy-square sy-ts">[</span><span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>../build/*<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span><span class="sy-meta sy-brace sy-square sy-ts">]</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span>
<span class="sy-punctuation sy-whitespace sy-comment sy-leading sy-ts">  </span><span class="sy-comment sy-line sy-double-slash sy-ts"><span class="sy-punctuation sy-definition sy-comment sy-ts">//</span></span><span class="sy-comment sy-line sy-double-slash sy-ts"> JavaScript language support target</span>
  <span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts">target</span></span><span class="sy-meta sy-object sy-member sy-ts"><span class="sy-meta sy-object-literal sy-key sy-ts"><span class="sy-punctuation sy-separator sy-key-value sy-ts">:</span></span> <span class="sy-string sy-quoted sy-single sy-ts"><span class="sy-punctuation sy-definition sy-string sy-begin sy-ts">&#39;</span>node18<span class="sy-punctuation sy-definition sy-string sy-end sy-ts">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-ts">,</span> 
<span class="sy-punctuation sy-definition sy-block sy-ts">}</span></span><span class="sy-meta sy-brace sy-round sy-ts">)</span><span class="sy-punctuation sy-terminator sy-statement sy-ts">;</span>
</span></code></pre>
                <p>The <code>external</code> option is the most unusual thing here, but it is just telling esbuild to not touch imports from <code>../build</code>, which contains the <code>adapter-node</code> output.</p>
                <p>The bundled output from esbuild then looks something like this:</p>
                <pre><code><span class="sy-source sy-js"><span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> server/index.js
</span><span class="sy-meta sy-import sy-js"><span class="sy-keyword sy-control sy-import-export sy-js">import</span> </span><span class="sy-meta sy-import sy-js"><span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span> <span class="sy-variable sy-other sy-readwrite sy-js">WebSocketServer</span> <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span> <span class="sy-keyword sy-control sy-import-export sy-js">from</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>ws<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span></span>
<span class="sy-storage sy-type sy-js">var</span> <span class="sy-meta sy-binding sy-name sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">wsServerKey</span></span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-support sy-class sy-builtin sy-js">Symbol</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-support sy-function sy-builtin sy-js">for</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>app.wsServer<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
<span class="sy-meta sy-function sy-js"></span><span class="sy-meta sy-function sy-declaration sy-js"><span class="sy-storage sy-type sy-function sy-js">function</span> <span class="sy-entity sy-name sy-function sy-js">handleWsUpgrade</span><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-binding sy-name sy-js"><span class="sy-variable sy-parameter sy-function sy-js">req</span></span><span class="sy-punctuation sy-separator sy-parameter sy-function sy-js">,</span> <span class="sy-meta sy-binding sy-name sy-js"><span class="sy-variable sy-parameter sy-function sy-js">sock</span></span><span class="sy-punctuation sy-separator sy-parameter sy-function sy-js">,</span> <span class="sy-meta sy-binding sy-name sy-js"><span class="sy-variable sy-parameter sy-function sy-js">head</span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span><span class="sy-meta sy-function sy-js"> <span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
  <span class="sy-storage sy-type sy-js">const</span> <span class="sy-meta sy-binding sy-name sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">wsServer</span></span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-meta sy-function-call sy-js"><span class="sy-variable sy-function sy-js">getWebsocketServer</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-meta sy-conditional sy-js"><span class="sy-keyword sy-control sy-conditional sy-if sy-js">if</span> <span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">wsServer</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-variable sy-function sy-js">shouldHandle</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-variable sy-other sy-readwrite sy-js">req</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span> <span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
    <span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">wsServer</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-variable sy-function sy-js">handleUpgrade</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-variable sy-other sy-readwrite sy-js">req</span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span> <span class="sy-variable sy-other sy-readwrite sy-js">sock</span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span> <span class="sy-variable sy-other sy-readwrite sy-js">head</span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span> <span class="sy-meta sy-function sy-js"></span><span class="sy-meta sy-function sy-declaration sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-binding sy-name sy-js"><span class="sy-variable sy-parameter sy-function sy-js">ws</span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span> <span class="sy-storage sy-type sy-function sy-arrow sy-js">=&gt;</span></span><span class="sy-meta sy-function sy-js"> <span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
      <span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">wsServer</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-variable sy-function sy-js">emit</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>connection<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span> <span class="sy-variable sy-other sy-readwrite sy-js">ws</span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span> <span class="sy-variable sy-other sy-readwrite sy-js">req</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
    <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span></span>
<span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span></span>

<span class="sy-meta sy-import sy-js"><span class="sy-keyword sy-control sy-import-export sy-js">import</span> </span><span class="sy-meta sy-import sy-js"><span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span> <span class="sy-variable sy-other sy-readwrite sy-js">server</span> <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span> <span class="sy-keyword sy-control sy-import-export sy-js">from</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>../build/index.js<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span></span>
<span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">server</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-meta sy-property sy-object sy-js">server</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-variable sy-function sy-js">on</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-double sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&quot;</span>upgrade<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&quot;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span> <span class="sy-variable sy-other sy-readwrite sy-js">handleWsUpgrade</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
</span></code></pre>

            <h4>Building the Project</h4>
                <p>The last step is to update your <code>package.json</code> scripts to build the server as well.</p>
                <pre><code><span class="sy-source sy-json"><span class="sy-meta sy-mapping sy-json"><span class="sy-punctuation sy-section sy-mapping sy-begin sy-json">{</span>
  <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-json">//</span> Other stuff omitted
</span>  </span><span class="sy-meta sy-mapping sy-key sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>scripts<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span></span><span class="sy-meta sy-mapping sy-json"><span class="sy-punctuation sy-separator sy-mapping sy-key-value sy-json">:</span> </span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-meta sy-mapping sy-json"><span class="sy-punctuation sy-section sy-mapping sy-begin sy-json">{</span>
    </span><span class="sy-meta sy-mapping sy-key sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>build<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span></span><span class="sy-meta sy-mapping sy-json"><span class="sy-punctuation sy-separator sy-mapping sy-key-value sy-json">:</span> </span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>vite build &amp;&amp; pnpm run build-server<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span><span class="sy-punctuation sy-separator sy-mapping sy-pair sy-json">,</span>
    </span><span class="sy-meta sy-mapping sy-key sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>build-server<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span></span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-punctuation sy-separator sy-mapping sy-key-value sy-json">:</span> </span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>node server.esbuild.mjs<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span><span class="sy-punctuation sy-separator sy-mapping sy-pair sy-json">,</span>
    </span><span class="sy-meta sy-mapping sy-key sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>start<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span></span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-punctuation sy-separator sy-mapping sy-key-value sy-json">:</span> </span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>node server/index.js<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span>
  <span class="sy-punctuation sy-section sy-mapping sy-end sy-json">}</span></span>
<span class="sy-punctuation sy-section sy-mapping sy-end sy-json">}</span></span>
</span></code></pre>



    <h2>Connecting from the Client</h2>
        <h4>Partysocket</h4>
            <p>Client WebSocket setup is pretty much the same as any other framework, and you can use any abstractions over WebSockets that you want, or just the browser&#39;s built-in WebSocket class.</p>
            <p>Most applications will want to do things like automatically reconnect when the connection is temporarily lost. For this, we can turn to the <code>partysocket</code> library. This library is a fork of <code>reconnecting-websocket</code>, and it handles reconnecting, buffering outgoing messages while offline, and so on, while presenting an API that looks basically the same as a plain WebSocket.</p>
            <p>The <code>partysocket</code> library depends on <code>react</code>, but the React usage is cleanly separated from the plain JavaScript code, so it actually works to add a <code>.pnpmfile.cjs</code> and remove <code>react</code> if you want to trim your dependency tree.</p>
            <pre><code><span class="sy-source sy-js"><span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> .pnpmfile.cjs
</span><span class="sy-meta sy-function sy-js"></span><span class="sy-meta sy-function sy-declaration sy-js"><span class="sy-storage sy-type sy-function sy-js">function</span> <span class="sy-entity sy-name sy-function sy-js">readPackage</span><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-binding sy-name sy-js"><span class="sy-variable sy-parameter sy-function sy-js">pkg</span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span><span class="sy-meta sy-function sy-js"> <span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
  <span class="sy-meta sy-conditional sy-js"><span class="sy-keyword sy-control sy-conditional sy-if sy-js">if</span> <span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-variable sy-other sy-readwrite sy-js">pkg</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-meta sy-property sy-object sy-js">name</span> <span class="sy-keyword sy-operator sy-comparison sy-js">===</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>partysocket<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span> <span class="sy-keyword sy-operator sy-logical sy-js">&amp;&amp;</span> <span class="sy-variable sy-other sy-readwrite sy-js">pkg</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-meta sy-property sy-object sy-js">dependencies</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span> <span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
    <span class="sy-keyword sy-operator sy-js">delete</span> <span class="sy-variable sy-other sy-readwrite sy-js">pkg</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-meta sy-property sy-object sy-js">dependencies</span><span class="sy-meta sy-brackets sy-js"><span class="sy-punctuation sy-section sy-brackets sy-begin sy-js">[</span><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>react<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span><span class="sy-punctuation sy-section sy-brackets sy-end sy-js">]</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span></span>
  <span class="sy-keyword sy-control sy-flow sy-return sy-js">return</span> <span class="sy-variable sy-other sy-readwrite sy-js">pkg</span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
<span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span></span>

<span class="sy-support sy-constant sy-node sy-js">module</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-support sy-constant sy-node sy-js">exports</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-meta sy-mapping sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
  <span class="sy-meta sy-mapping sy-key sy-js">hooks</span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span> <span class="sy-meta sy-mapping sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
    <span class="sy-variable sy-other sy-readwrite sy-js">readPackage</span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
  <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span>
<span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>

</span></code></pre>
            <p>Note that this is completely optional. It will reduce the size of your <code>node_modules</code>, but leaving in the <code>react</code> dependency will not have any negative effect on the built application.</p>

        <h4>Making the Connection</h4>
            <p>Once <code>partysocket</code> is installed, you can use it like a normal WebSocket connection. We do this in an <code>onMount</code> function so that it won&#39;t run in SSR.</p>
            <pre><code><span class="sy-source sy-js"><span class="sy-meta sy-import sy-js"><span class="sy-keyword sy-control sy-import-export sy-js">import</span> </span><span class="sy-meta sy-import sy-js"><span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span> <span class="sy-variable sy-other sy-readwrite sy-js">WebSocket</span> <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span> <span class="sy-keyword sy-control sy-import-export sy-js">from</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>partysocket<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span></span>
<span class="sy-meta sy-import sy-js"><span class="sy-keyword sy-control sy-import-export sy-js">import</span> </span><span class="sy-meta sy-import sy-js"><span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span> <span class="sy-variable sy-other sy-readwrite sy-js">onMount</span> <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span> <span class="sy-keyword sy-control sy-import-export sy-js">from</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>svelte<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span></span>
<span class="sy-meta sy-import sy-js"><span class="sy-keyword sy-control sy-import-export sy-js">import</span> </span><span class="sy-meta sy-import sy-js"><span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span> <span class="sy-variable sy-other sy-readwrite sy-js">page</span> <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span> <span class="sy-keyword sy-control sy-import-export sy-js">from</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>$app/stores<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span></span>

<span class="sy-storage sy-type sy-js">let</span> <span class="sy-meta sy-binding sy-name sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">ws</span></span> : <span class="sy-variable sy-other sy-constant sy-js">WebSocket</span><span class="sy-keyword sy-operator sy-bitwise sy-js">|</span><span class="sy-constant sy-language sy-null sy-js">null</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-constant sy-language sy-null sy-js">null</span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>

<span class="sy-meta sy-function-call sy-js"><span class="sy-variable sy-function sy-js">onMount</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-function sy-js"></span><span class="sy-meta sy-function sy-declaration sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span> <span class="sy-storage sy-type sy-function sy-arrow sy-js">=&gt;</span></span><span class="sy-meta sy-function sy-js"> <span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
  <span class="sy-storage sy-type sy-js">const</span> <span class="sy-meta sy-binding sy-name sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">wsPath</span></span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-keyword sy-operator sy-word sy-new sy-js">new</span><span class="sy-meta sy-function-call sy-constructor sy-js"> <span class="sy-variable sy-type sy-js">URL</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>/ws<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span> <span class="sy-variable sy-other sy-dollar sy-js"><span class="sy-punctuation sy-dollar sy-js">$</span>page</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-meta sy-property sy-object sy-js">url</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-meta sy-property sy-object sy-js">origin</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> WebSocket URLs use a different protocol, and like http there are
</span>  <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> both secure and non-secure versions.
</span>  <span class="sy-variable sy-other sy-readwrite sy-js">wsPath</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-meta sy-property sy-object sy-js">protocol</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-variable sy-other sy-readwrite sy-js">wsPath</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-meta sy-property sy-object sy-js">protocol</span> <span class="sy-keyword sy-operator sy-comparison sy-js">===</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>https<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span> <span class="sy-keyword sy-operator sy-ternary sy-js">?</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>wss:<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span> <span class="sy-keyword sy-operator sy-ternary sy-js">:</span> <span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>ws:<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-variable sy-other sy-readwrite sy-js">ws</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-keyword sy-operator sy-word sy-new sy-js">new</span><span class="sy-meta sy-function-call sy-constructor sy-js"> <span class="sy-variable sy-type sy-js">WebSocket</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">wsPath</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-support sy-function sy-js">toString</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  
  <span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">ws</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-variable sy-function sy-js">addEventListener</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>error<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span> <span class="sy-meta sy-function sy-js"></span><span class="sy-meta sy-function sy-declaration sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-binding sy-name sy-js"><span class="sy-variable sy-parameter sy-function sy-js">e</span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span> <span class="sy-storage sy-type sy-function sy-arrow sy-js">=&gt;</span></span><span class="sy-meta sy-function sy-js"> <span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
    <span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-support sy-type sy-object sy-console sy-js">console</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-support sy-function sy-console sy-js">error</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>ws error<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span> <span class="sy-variable sy-other sy-readwrite sy-js">e</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  
  <span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">ws</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-variable sy-function sy-js">addEventListener</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>open<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span> <span class="sy-meta sy-function sy-js"></span><span class="sy-meta sy-function sy-declaration sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span> <span class="sy-storage sy-type sy-function sy-arrow sy-js">=&gt;</span></span><span class="sy-meta sy-function sy-js"> <span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
    <span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-support sy-type sy-object sy-console sy-js">console</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-support sy-function sy-console sy-js">log</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>connection opened<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  
  <span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-variable sy-other sy-readwrite sy-js">ws</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-variable sy-function sy-js">addEventListener</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-string sy-js"><span class="sy-string sy-quoted sy-single sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>message<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span></span><span class="sy-punctuation sy-separator sy-comma sy-js">,</span> <span class="sy-meta sy-function sy-js"></span><span class="sy-meta sy-function sy-declaration sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-meta sy-binding sy-name sy-js"><span class="sy-variable sy-parameter sy-function sy-js">ev</span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span> <span class="sy-storage sy-type sy-function sy-arrow sy-js">=&gt;</span></span><span class="sy-meta sy-function sy-js"> <span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
    <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> handle the message
</span>  <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  
  <span class="sy-keyword sy-control sy-flow sy-return sy-js">return</span> <span class="sy-meta sy-function sy-js"></span><span class="sy-meta sy-function sy-declaration sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span> <span class="sy-storage sy-type sy-function sy-arrow sy-js">=&gt;</span></span><span class="sy-meta sy-function sy-js"> <span class="sy-meta sy-block sy-js"><span class="sy-punctuation sy-section sy-block sy-begin sy-js">{</span>
    <span class="sy-variable sy-other sy-readwrite sy-js">ws</span><span class="sy-keyword sy-operator sy-ternary sy-js">?</span><span class="sy-punctuation sy-accessor sy-js">.</span><span class="sy-meta sy-function-call sy-method sy-js"><span class="sy-variable sy-function sy-js">close</span><span class="sy-meta sy-group sy-js"><span class="sy-punctuation sy-section sy-group sy-begin sy-js">(</span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
    <span class="sy-variable sy-other sy-readwrite sy-js">ws</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-constant sy-language sy-null sy-js">null</span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
<span class="sy-punctuation sy-section sy-block sy-end sy-js">}</span></span></span><span class="sy-punctuation sy-section sy-group sy-end sy-js">)</span></span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
</span></code></pre>
            <p>And that&#39;s it! Now you have a working SvelteKit WebSocket implementation in development mode and when running in production.</p>





