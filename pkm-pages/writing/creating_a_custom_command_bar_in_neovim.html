---
title: "Creating a Custom Command Bar in Neovim"
tags: 
date: 2023-04-14
updated: 2023-04-14
draft: false
---


    
    <p>Command bars are a useful addition to many applications that let you search for and execute commands. Neovim&#39;s <a href="https://github.com/nvim-telescope/telescope.nvim">Telescope</a> plugin provides the pieces to create your own with just a bit of Lua programming.</p>
    <p>
<picture>
  <source srcset="https://images.imfeld.dev/blog/vim-command-bar_1681452546770_0-w650-AYd-YcGLof67sIfdRG4sZw.avif" type="image/avif" width="650" height="389" />
  <source srcset="https://images.imfeld.dev/blog/vim-command-bar_1681452546770_0-w650-AYd-YcGLof67sIfdRG4sZw.webp" type="image/webp" width="650" height="389" />
  <source srcset="https://images.imfeld.dev/blog/vim-command-bar_1681452546770_0-w650-AYd-YcGLof67sIfdRG4sZw.png" type="image/png" width="650" height="389" />
  <img src="https://images.imfeld.dev/blog/vim-command-bar_1681452546770_0-w650-AYd-YcGLof67sIfdRG4sZw.png" alt="vim-command-bar.png" width="650" height="389" />
</picture>
</p>
    <p>Telescope can be <a href="https://github.com/nvim-telescope/telescope.nvim#installation">installed using any Neovim plugin manager</a>, and then you&#39;re ready to dive in. Even if you haven&#39;t used Lua before, this is fairly straightforward.</p>
    <p>First, we&#39;ll start by importing some modules.</p>
    <pre><code><span class="sy-source sy-lua"><span class="sy-keyword sy-control sy-lua">local</span> telescope <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-support sy-function sy-lua">require</span> <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>telescope<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>;
<span class="sy-keyword sy-control sy-lua">local</span> pickers <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-support sy-function sy-lua">require</span> <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>telescope.pickers<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>
<span class="sy-keyword sy-control sy-lua">local</span> finders <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-support sy-function sy-lua">require</span> <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>telescope.finders<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>
</span></code></pre>
    <p>The main modules to be aware of here are <code>pickers</code> and <code>finders</code>. A picker is the actual Telescope window that pops up, and the finder provides the items to show in the picker.</p>
    <h2>Defining the Commands</h2>
    <p>Next, we&#39;ll define our commands. This may look a bit weird if you&#39;re not used to Lua, but objects and arrays are sort of the same thing here, so they both use braces. Lua calls them both &quot;tables.&quot;</p>
    <p>The actual structure of the commands can look however you want, since you&#39;ll convert them to the format that Telescope uses later. Here I have a name, a category, and a function to run when the command is selected, but you can add additional information or functions if you want.</p>
    <pre><code><span class="sy-source sy-lua"><span class="sy-keyword sy-control sy-lua">local</span> commands <span class="sy-keyword sy-operator sy-lua">=</span> {
  { 
    name <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>Organize imports<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>, 
    category <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-string sy-quoted sy-double sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&quot;</span>LS<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&quot;</span></span>, 
    action <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-keyword sy-control sy-lua">function</span>() 
      vim.fn.CocAction(<span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>runCommand<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>, <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>editor.action.organizeImport<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>)
    <span class="sy-keyword sy-control sy-lua">end</span>
  },
  { 
    name <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>Format document<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>,
    category <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-string sy-quoted sy-double sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&quot;</span>LS<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&quot;</span></span>,
    action <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-keyword sy-control sy-lua">function</span>()
      vim.fn.CocAction(<span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>runCommand<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>, <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>editor.action.formatDocument<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>)
    <span class="sy-keyword sy-control sy-lua">end</span>
  },
  { 
    name <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>Git Difftool<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>,
    category <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-string sy-quoted sy-double sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&quot;</span>Git<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&quot;</span></span>, 
    action <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-keyword sy-control sy-lua">function</span> () vim.cmd(<span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>Git difftool<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>) <span class="sy-keyword sy-control sy-lua">end</span>
  },
}
</span></code></pre>
    <h2>Formatting</h2>
    <p>The picker in the screenshot above has two columns: the command&#39;s name and category. We can use the <code>entry_display</code> module to help with this formatting. It does not autosize columns though, so  first we need to find our column widths.</p>
    <p>This code snippet figures out the longest command name. (The <code>#</code> operator returns the length of a string.)</p>
    <pre><code><span class="sy-source sy-lua"><span class="sy-keyword sy-control sy-lua">local</span> longest_command_name <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-constant sy-numeric sy-lua">0</span>
<span class="sy-keyword sy-control sy-lua">for</span> _, command <span class="sy-keyword sy-control sy-lua">in</span> <span class="sy-support sy-function sy-lua">ipairs</span>(commands) <span class="sy-keyword sy-control sy-lua">do</span>
  <span class="sy-keyword sy-control sy-lua">if</span> <span class="sy-keyword sy-operator sy-lua">#</span>command.name <span class="sy-keyword sy-operator sy-lua">&gt;</span> longest_command_name <span class="sy-keyword sy-control sy-lua">then</span>
    longest_command_name <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-keyword sy-operator sy-lua">#</span>command.name
  <span class="sy-keyword sy-control sy-lua">end</span>
<span class="sy-keyword sy-control sy-lua">end</span>

</span></code></pre>
    <p>Next, we can create our formatter.</p>
    <pre><code><span class="sy-source sy-lua"><span class="sy-keyword sy-control sy-lua">local</span> entry_display <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-support sy-function sy-lua">require</span> <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>telescope.pickers.entry_display<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>
<span class="sy-keyword sy-control sy-lua">local</span> displayer <span class="sy-keyword sy-operator sy-lua">=</span> entry_display.create {
  separator <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-string sy-quoted sy-double sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&quot;</span> <span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&quot;</span></span>,
  items <span class="sy-keyword sy-operator sy-lua">=</span> {
    { width <span class="sy-keyword sy-operator sy-lua">=</span> longest_command_name <span class="sy-keyword sy-operator sy-lua">+</span> <span class="sy-constant sy-numeric sy-lua">2</span> },
    <span class="sy-comment sy-line sy-double-dash sy-lua"><span class="sy-punctuation sy-definition sy-comment sy-lua">--</span> The final column can be set to fill the remaining space
</span>    { remaining <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-constant sy-language sy-lua">true</span> }, 
  },
}
</span></code></pre>
    <h2>The Finder</h2>
    <p>With your commands set up, you can create a finder to hold the items. Telescope&#39;s finders support a lot of functionality, but here we just have a fixed set of commands in a table. The <code>finders.new_table</code> method creates a simple finder that can populate its results from this table.</p>
    <pre><code><span class="sy-source sy-lua"><span class="sy-keyword sy-control sy-lua">local</span> finder <span class="sy-keyword sy-operator sy-lua">=</span> finders.new_table {
  results <span class="sy-keyword sy-operator sy-lua">=</span> commands,
  entry_maker <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-keyword sy-control sy-lua">function</span>(entry)
    <span class="sy-keyword sy-control sy-lua">return</span> {
      value <span class="sy-keyword sy-operator sy-lua">=</span> entry,
      display <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-keyword sy-control sy-lua">function</span>(ent)
        <span class="sy-keyword sy-control sy-lua">return</span> displayer {
          ent.value.name,
          { ent.value.category, <span class="sy-string sy-quoted sy-double sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&quot;</span>TelescopeResultsComment<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&quot;</span></span> }
        }
      <span class="sy-keyword sy-control sy-lua">end</span>,
      ordinal <span class="sy-keyword sy-operator sy-lua">=</span> entry.name,
    }
  <span class="sy-keyword sy-control sy-lua">end</span>,
}
</span></code></pre>
    The <code>entry_maker</code> function above returns information for the picker to use.
      <ul class="list-bullet">
        <li>The <code>value</code> can be any arbitrary data. In this case we just use the <code>entry</code> itself.</li>
        <li><code>display</code> is a function that formats the item. We use our <code>displayer</code> from above to format the name and the category, with a highlight group applied to the category.</li>
        <li><code>ordinal</code> is the input to the picker&#39;s sorting algorithm. Here we&#39;re just sorting by name.</li>
      </ul>
    <h2>Showing the Window</h2>
    <p>Now we&#39;re ready to actually show our picker.</p>
    <pre><code><span class="sy-source sy-lua"><span class="sy-keyword sy-control sy-lua">local</span> showCommandBar <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-keyword sy-control sy-lua">function</span>(opts)
  opts <span class="sy-keyword sy-operator sy-lua">=</span> opts <span class="sy-keyword sy-operator sy-lua">or</span> {}
  
  <span class="sy-keyword sy-control sy-lua">local</span> conf <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-support sy-function sy-lua">require</span> <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>telescope.config<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>.values
  <span class="sy-keyword sy-control sy-lua">local</span> actions <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-support sy-function sy-lua">require</span> <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>telescope.actions<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>
  <span class="sy-keyword sy-control sy-lua">local</span> action_state <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-support sy-function sy-lua">require</span> <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>telescope.actions.state<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>
  
  pickers.new(opts, {
    prompt_title <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>Common commands<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>,
    finder <span class="sy-keyword sy-operator sy-lua">=</span> finder,
    <span class="sy-comment sy-line sy-double-dash sy-lua"><span class="sy-punctuation sy-definition sy-comment sy-lua">--</span> Use the default sorter
</span>    sorter <span class="sy-keyword sy-operator sy-lua">=</span> conf.generic_sorter(opts),
    attach_mappings <span class="sy-keyword sy-operator sy-lua">=</span> <span class="sy-keyword sy-control sy-lua">function</span>(prompt_bufnr, map)
      map(<span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>i<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>, <span class="sy-string sy-quoted sy-single sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&#39;</span>&lt;CR&gt;<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&#39;</span></span>, <span class="sy-keyword sy-control sy-lua">function</span>()
        actions.close(prompt_bufnr)
        <span class="sy-keyword sy-control sy-lua">local</span> selection <span class="sy-keyword sy-operator sy-lua">=</span> action_state.get_selected_entry(prompt_bufnr)
        selection.value.action()
      <span class="sy-keyword sy-control sy-lua">end</span>)
      <span class="sy-keyword sy-control sy-lua">return</span> <span class="sy-constant sy-language sy-lua">true</span>
    <span class="sy-keyword sy-control sy-lua">end</span>,
  }):find()

<span class="sy-keyword sy-control sy-lua">end</span>

vim.keymap.set(<span class="sy-string sy-quoted sy-double sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&quot;</span>n<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&quot;</span></span>, <span class="sy-string sy-quoted sy-double sy-lua"><span class="sy-punctuation sy-definition sy-string sy-begin sy-lua">&quot;</span>&lt;leader&gt;k<span class="sy-punctuation sy-definition sy-string sy-end sy-lua">&quot;</span></span>. showCommandBar)
</span></code></pre>
    <p>Here we use the default sorter from the Telescope configuration. The <code>attach_mappings</code> argument lets us add special actions into the picker, and we add one action so that the Enter key will close the picker, get the selected item, and run its action.</p>
    <p>Finally, we created a key mapping that would run the function. And that&#39;s it!</p>
    <h2>Next Steps</h2>
    <p>We covered just the basics here, but there&#39;s a lot of opportunity for more advanced functionality.</p>
    <p>By moving more of this code inside the <code>showCommandBar</code> function, you could customize the commands based on aspects of the current buffer, such as showing certain commands only for certain file types.</p>
    <p>If you build any other cool functionality around this, I&#39;d love to hear it!</p>



