---
title: "2023-03-07"
tags: 
date: 2023-03-07
updated: 2023-03-08
---


    
    <p>Today I encountered an issue using Vite with the Rush monorepo software. Rush keeps its lockfile in an unusual place, and so Vite could not automatically check the lockfile to know when to clear its cache. But it turns out to be pretty easy to code your own logic here.</p>
    <pre><code><span class="sy-source sy-js"><span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> vite.config.js
</span><span class="sy-keyword sy-operator sy-module sy-js">import</span> <span class="sy-keyword sy-operator sy-arithmetic sy-js">*</span> <span class="sy-keyword sy-operator sy-module sy-js">as</span> <span class="sy-variable sy-other sy-readwrite sy-js">fs</span> <span class="sy-keyword sy-operator sy-module sy-js">from</span> <span class="sy-string sy-quoted sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>fs<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
<span class="sy-keyword sy-operator sy-module sy-js">import</span> <span class="sy-keyword sy-operator sy-arithmetic sy-js">*</span> <span class="sy-keyword sy-operator sy-module sy-js">as</span> <span class="sy-variable sy-other sy-readwrite sy-js">path</span> <span class="sy-keyword sy-operator sy-module sy-js">from</span> <span class="sy-string sy-quoted sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>path<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
<span class="sy-keyword sy-operator sy-module sy-js">import</span> <span class="sy-meta sy-group sy-braces sy-curly sy-js"><span class="sy-meta sy-brace sy-curly sy-begin sy-js">{</span> <span class="sy-variable sy-other sy-readwrite sy-js">fileURLToPath</span> <span class="sy-meta sy-brace sy-curly sy-end sy-js">}</span></span> <span class="sy-keyword sy-operator sy-module sy-js">from</span> <span class="sy-string sy-quoted sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>url<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>

<span class="sy-storage sy-type sy-js">const</span> <span class="sy-variable sy-other sy-readwrite sy-js">dirname</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-variable sy-other sy-object sy-js"><span class="sy-variable sy-other sy-object sy-js">path</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-function-call sy-method sy-with-arguments sy-js"><span class="sy-variable sy-function sy-js">dirname</span></span><span class="sy-meta sy-group sy-braces sy-round sy-js"><span class="sy-meta sy-brace sy-round sy-begin sy-js">(</span><span class="sy-meta sy-function-call sy-with-arguments sy-js"><span class="sy-variable sy-function sy-js">fileURLToPath</span></span><span class="sy-meta sy-group sy-braces sy-round sy-js"><span class="sy-meta sy-brace sy-round sy-begin sy-js">(</span><span class="sy-keyword sy-operator sy-module sy-js">import</span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-property sy-object sy-js"><span class="sy-variable sy-other sy-property sy-js">meta</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-property sy-object sy-js"><span class="sy-variable sy-other sy-property sy-js">url</span></span><span class="sy-meta sy-brace sy-round sy-end sy-js">)</span></span><span class="sy-meta sy-brace sy-round sy-end sy-js">)</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>

<span class="sy-meta sy-function sy-js"><span class="sy-storage sy-type sy-function sy-js">function</span> <span class="sy-entity sy-name sy-function sy-js">lockfileNeedsRebuild</span><span class="sy-punctuation sy-definition sy-parameters sy-begin sy-js">(</span><span class="sy-punctuation sy-definition sy-parameters sy-end sy-js">)</span></span> <span class="sy-meta sy-group sy-braces sy-curly sy-js"><span class="sy-meta sy-brace sy-curly sy-begin sy-js">{</span>
  <span class="sy-storage sy-type sy-js">const</span> <span class="sy-variable sy-other sy-readwrite sy-js">lockFilePath</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-variable sy-other sy-object sy-js"><span class="sy-variable sy-other sy-object sy-js">path</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-function-call sy-method sy-with-arguments sy-js"><span class="sy-variable sy-function sy-js">resolve</span></span><span class="sy-meta sy-group sy-braces sy-round sy-js"><span class="sy-meta sy-brace sy-round sy-begin sy-js">(</span>
    <span class="sy-variable sy-other sy-readwrite sy-js">dirname</span>,
    <span class="sy-string sy-quoted sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>../../common/config/rush/pnpm-lock.yaml<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span>
  <span class="sy-meta sy-brace sy-round sy-end sy-js">)</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-storage sy-type sy-js">const</span> <span class="sy-variable sy-other sy-readwrite sy-js">lockFileDatePath</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-variable sy-other sy-object sy-js"><span class="sy-variable sy-other sy-object sy-js">path</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-function-call sy-method sy-with-arguments sy-js"><span class="sy-variable sy-function sy-js">resolve</span></span><span class="sy-meta sy-group sy-braces sy-round sy-js"><span class="sy-meta sy-brace sy-round sy-begin sy-js">(</span><span class="sy-variable sy-other sy-readwrite sy-js">dirname</span>, <span class="sy-string sy-quoted sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span>.last-lockfile-date<span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span><span class="sy-meta sy-brace sy-round sy-end sy-js">)</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>

  <span class="sy-storage sy-type sy-js">let</span> <span class="sy-variable sy-other sy-readwrite sy-js">lockFileSavedDate</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-string sy-quoted sy-js"><span class="sy-punctuation sy-definition sy-string sy-begin sy-js">&#39;</span><span class="sy-punctuation sy-definition sy-string sy-end sy-js">&#39;</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-keyword sy-control sy-trycatch sy-js">try</span> <span class="sy-meta sy-group sy-braces sy-curly sy-js"><span class="sy-meta sy-brace sy-curly sy-begin sy-js">{</span>
    <span class="sy-variable sy-other sy-readwrite sy-js">lockFileSavedDate</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-variable sy-other sy-object sy-js"><span class="sy-variable sy-other sy-object sy-js">fs</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-function-call sy-method sy-with-arguments sy-js"><span class="sy-variable sy-function sy-js">readFileSync</span></span><span class="sy-meta sy-group sy-braces sy-round sy-js"><span class="sy-meta sy-brace sy-round sy-begin sy-js">(</span><span class="sy-variable sy-other sy-readwrite sy-js">lockFileDatePath</span><span class="sy-meta sy-brace sy-round sy-end sy-js">)</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-function-call sy-method sy-without-arguments sy-js"><span class="sy-variable sy-function sy-js">toString</span><span class="sy-meta sy-group sy-braces sy-round sy-function sy-arguments sy-js">()</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-meta sy-brace sy-curly sy-end sy-js">}</span></span> <span class="sy-keyword sy-control sy-trycatch sy-js">catch</span> <span class="sy-meta sy-group sy-braces sy-round sy-js"><span class="sy-meta sy-brace sy-round sy-begin sy-js">(</span><span class="sy-variable sy-other sy-readwrite sy-js">e</span><span class="sy-meta sy-brace sy-round sy-end sy-js">)</span></span> <span class="sy-meta sy-group sy-braces sy-curly sy-js"><span class="sy-meta sy-brace sy-curly sy-begin sy-js">{</span>
    <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> It&#39;s fine if there is no existing file.
</span>  <span class="sy-meta sy-brace sy-curly sy-end sy-js">}</span></span>

  <span class="sy-storage sy-type sy-js">const</span> <span class="sy-variable sy-other sy-readwrite sy-js">lockFileDate</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-variable sy-other sy-object sy-js"><span class="sy-variable sy-other sy-object sy-js">fs</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-function-call sy-method sy-with-arguments sy-js"><span class="sy-variable sy-function sy-js">statSync</span></span><span class="sy-meta sy-group sy-braces sy-round sy-js"><span class="sy-meta sy-brace sy-round sy-begin sy-js">(</span><span class="sy-variable sy-other sy-readwrite sy-js">lockFilePath</span><span class="sy-meta sy-brace sy-round sy-end sy-js">)</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-property sy-object sy-js"><span class="sy-variable sy-other sy-property sy-js">mtime</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-function-call sy-method sy-without-arguments sy-js"><span class="sy-variable sy-function sy-js">valueOf</span><span class="sy-meta sy-group sy-braces sy-round sy-function sy-arguments sy-js">()</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-function-call sy-method sy-without-arguments sy-js"><span class="sy-variable sy-function sy-js">toString</span><span class="sy-meta sy-group sy-braces sy-round sy-function sy-arguments sy-js">()</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>

  <span class="sy-keyword sy-control sy-conditional sy-js">if</span> <span class="sy-meta sy-group sy-braces sy-round sy-js"><span class="sy-meta sy-brace sy-round sy-begin sy-js">(</span><span class="sy-variable sy-other sy-object sy-js"><span class="sy-variable sy-other sy-object sy-js">lockFileSavedDate</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-function-call sy-method sy-without-arguments sy-js"><span class="sy-variable sy-function sy-js">trim</span><span class="sy-meta sy-group sy-braces sy-round sy-function sy-arguments sy-js">()</span></span> <span class="sy-keyword sy-operator sy-comparison sy-js">!==</span> <span class="sy-variable sy-other sy-readwrite sy-js">lockFileDate</span><span class="sy-meta sy-brace sy-round sy-end sy-js">)</span></span> <span class="sy-meta sy-group sy-braces sy-curly sy-js"><span class="sy-meta sy-brace sy-curly sy-begin sy-js">{</span>
    <span class="sy-variable sy-other sy-object sy-js"><span class="sy-variable sy-other sy-object sy-js">fs</span></span><span class="sy-keyword sy-operator sy-accessor sy-js">.</span><span class="sy-meta sy-function-call sy-method sy-with-arguments sy-js"><span class="sy-variable sy-function sy-js">writeFileSync</span></span><span class="sy-meta sy-group sy-braces sy-round sy-js"><span class="sy-meta sy-brace sy-round sy-begin sy-js">(</span><span class="sy-variable sy-other sy-readwrite sy-js">lockFileDatePath</span>, <span class="sy-variable sy-other sy-readwrite sy-js">lockFileDate</span><span class="sy-meta sy-brace sy-round sy-end sy-js">)</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
    <span class="sy-keyword sy-control sy-flow sy-js">return</span> <span class="sy-constant sy-language sy-boolean sy-true sy-js">true</span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
  <span class="sy-meta sy-brace sy-curly sy-end sy-js">}</span></span>

  <span class="sy-keyword sy-control sy-flow sy-js">return</span> <span class="sy-constant sy-language sy-boolean sy-false sy-js">false</span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
<span class="sy-meta sy-brace sy-curly sy-end sy-js">}</span></span>

<span class="sy-comment sy-block sy-documentation sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">/**</span> @type {import(&#39;vite&#39;).UserConfig} <span class="sy-punctuation sy-definition sy-comment sy-js">*/</span></span>
<span class="sy-storage sy-type sy-js">const</span> <span class="sy-variable sy-other sy-readwrite sy-js">config</span> <span class="sy-keyword sy-operator sy-assignment sy-js">=</span> <span class="sy-meta sy-group sy-braces sy-curly sy-js"><span class="sy-meta sy-brace sy-curly sy-begin sy-js">{</span>
  <span class="sy-constant sy-other sy-object sy-key sy-js"><span class="sy-string sy-unquoted sy-label sy-js">optimizeDeps</span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span></span> <span class="sy-meta sy-group sy-braces sy-curly sy-js"><span class="sy-meta sy-brace sy-curly sy-begin sy-js">{</span>
    <span class="sy-constant sy-other sy-object sy-key sy-js"><span class="sy-string sy-unquoted sy-label sy-js">force</span><span class="sy-punctuation sy-separator sy-key-value sy-js">:</span></span> <span class="sy-meta sy-function-call sy-without-arguments sy-js"><span class="sy-variable sy-function sy-js">lockfileNeedsRebuild</span><span class="sy-meta sy-group sy-braces sy-round sy-function sy-arguments sy-js">()</span></span><span class="sy-meta sy-delimiter sy-comma sy-js">,</span>
  <span class="sy-meta sy-brace sy-curly sy-end sy-js">}</span></span><span class="sy-meta sy-delimiter sy-comma sy-js">,</span>
  <span class="sy-comment sy-line sy-double-slash sy-js"><span class="sy-punctuation sy-definition sy-comment sy-js">//</span> ... and other config
</span><span class="sy-meta sy-brace sy-curly sy-end sy-js">}</span></span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>
<span class="sy-keyword sy-operator sy-module sy-js">export</span> <span class="sy-keyword sy-control sy-loop sy-js">default</span> <span class="sy-variable sy-other sy-readwrite sy-js">config</span><span class="sy-punctuation sy-terminator sy-statement sy-js">;</span>

</span></code></pre>



