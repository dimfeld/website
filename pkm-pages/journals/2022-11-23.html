---
title: "2022-11-23"
tags: 
date: 2022-11-23
updated: 2022-11-24
---


    
    <p>Didn&#39;t have time to mention it here last night but the Let&#39;s Encrypt DNS challenge tool is all working. It starts the challenge, adds the required DNS entry to Vercel, and then uploads the resulting certificate to DigitalOcean and enables it.</p>
    <p>It&#39;s a bit over-engineered — I mean, a shell script run every 60 days would <em class="italic">probably</em> have been sufficient — but this will make it easier to add support for more hosts and services types in the future for other projects.</p>
    <p>I spent an hour trying to figure out why Let&#39;s Encrypt was rejecting my DNS record, and in the end turned out to be just a typo in my DNS record (<code>_acme_challenge</code> instead of <code>_acme-challenge</code>). But overall the process wasn&#39;t too bad.</p>
    <p>I&#39;ll get around to a full writeup in the near future, I hope, but in the meantime here&#39;s <a href="https://github.com/dimfeld/remote-ssl-renewal">the Github repo</a>.</p>

    <h3>Learning</h3>
        <p>In getting S3 upload for <a href="/notes/projects_pic_store">Pic Store</a> to work, I found that DigitalOcean Spaces defaults all files to private, with no way to change the default from the web UI. But you can use <code>s3cmd</code> to do it by setting the S3 bucket policy. First, create a policy JSON file:</p>
        <pre><code><span class="sy-source sy-json"><span class="sy-meta sy-mapping sy-json"><span class="sy-punctuation sy-section sy-mapping sy-begin sy-json">{</span>
    </span><span class="sy-meta sy-mapping sy-key sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>Version<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span></span><span class="sy-meta sy-mapping sy-json"><span class="sy-punctuation sy-separator sy-mapping sy-key-value sy-json">:</span> </span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>2008-10-17<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span><span class="sy-punctuation sy-separator sy-mapping sy-pair sy-json">,</span>
    </span><span class="sy-meta sy-mapping sy-key sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>Statement<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span></span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-punctuation sy-separator sy-mapping sy-key-value sy-json">:</span> </span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-meta sy-sequence sy-json"><span class="sy-punctuation sy-section sy-sequence sy-begin sy-json">[</span>
        <span class="sy-meta sy-mapping sy-json"><span class="sy-punctuation sy-section sy-mapping sy-begin sy-json">{</span>
        </span><span class="sy-meta sy-mapping sy-key sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>Sid<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span></span><span class="sy-meta sy-mapping sy-json"><span class="sy-punctuation sy-separator sy-mapping sy-key-value sy-json">:</span> </span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>AddPerm<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span><span class="sy-punctuation sy-separator sy-mapping sy-pair sy-json">,</span>
        </span><span class="sy-meta sy-mapping sy-key sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>Effect<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span></span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-punctuation sy-separator sy-mapping sy-key-value sy-json">:</span> </span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>Allow<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span><span class="sy-punctuation sy-separator sy-mapping sy-pair sy-json">,</span>
        </span><span class="sy-meta sy-mapping sy-key sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>Principal<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span></span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-punctuation sy-separator sy-mapping sy-key-value sy-json">:</span> </span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>*<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span><span class="sy-punctuation sy-separator sy-mapping sy-pair sy-json">,</span>
        </span><span class="sy-meta sy-mapping sy-key sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>Action<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span></span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-punctuation sy-separator sy-mapping sy-key-value sy-json">:</span> </span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>s3:GetObject<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span><span class="sy-punctuation sy-separator sy-mapping sy-pair sy-json">,</span>
        </span><span class="sy-meta sy-mapping sy-key sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>Resource<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span></span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-punctuation sy-separator sy-mapping sy-key-value sy-json">:</span> </span><span class="sy-meta sy-mapping sy-value sy-json"><span class="sy-string sy-quoted sy-double sy-json"><span class="sy-punctuation sy-definition sy-string sy-begin sy-json">&quot;</span>arn:aws:s3::YOUR_BUCKET_NAME/*<span class="sy-punctuation sy-definition sy-string sy-end sy-json">&quot;</span></span>
        <span class="sy-punctuation sy-section sy-mapping sy-end sy-json">}</span></span>
    <span class="sy-punctuation sy-section sy-sequence sy-end sy-json">]</span></span>
<span class="sy-punctuation sy-section sy-mapping sy-end sy-json">}</span></span>

</span></code></pre>
        <p>Then you can apply it to the bucket like so:</p>
        <pre><code><span class="sy-source sy-shell sy-bash"><span class="sy-meta sy-function-call sy-shell"><span class="sy-variable sy-function sy-shell">s3cmd</span></span><span class="sy-meta sy-function-call sy-arguments sy-shell"><span class="sy-variable sy-parameter sy-option sy-shell"><span class="sy-punctuation sy-definition sy-parameter sy-shell"> --</span>access_key</span><span class="sy-keyword sy-operator sy-assignment sy-option sy-shell">=</span><span class="sy-meta sy-group sy-expansion sy-parameter sy-shell"><span class="sy-punctuation sy-definition sy-variable sy-shell">$</span><span class="sy-variable sy-other sy-readwrite sy-shell">ACCESS_KEY</span></span><span class="sy-variable sy-parameter sy-option sy-shell"><span class="sy-punctuation sy-definition sy-parameter sy-shell"> --</span>secret_key</span><span class="sy-keyword sy-operator sy-assignment sy-option sy-shell">=</span><span class="sy-meta sy-group sy-expansion sy-parameter sy-shell"><span class="sy-punctuation sy-definition sy-variable sy-shell">$</span><span class="sy-variable sy-other sy-readwrite sy-shell">SECRET_KEY</span></span> <span class="sy-punctuation sy-separator sy-continuation sy-line sy-shell">\
</span><span class="sy-variable sy-parameter sy-option sy-shell"><span class="sy-punctuation sy-definition sy-parameter sy-shell">    --</span>host</span><span class="sy-keyword sy-operator sy-assignment sy-option sy-shell">=</span><span class="sy-meta sy-group sy-expansion sy-parameter sy-shell"><span class="sy-punctuation sy-definition sy-variable sy-shell">$</span><span class="sy-variable sy-other sy-readwrite sy-shell">REGION</span></span>.digitaloceanspaces.com <span class="sy-punctuation sy-separator sy-continuation sy-line sy-shell">\
</span><span class="sy-variable sy-parameter sy-option sy-shell"><span class="sy-punctuation sy-definition sy-parameter sy-shell">    --</span>host-bucket</span><span class="sy-keyword sy-operator sy-assignment sy-option sy-shell">=</span><span class="sy-meta sy-group sy-expansion sy-parameter sy-shell"><span class="sy-punctuation sy-definition sy-variable sy-shell">$</span><span class="sy-variable sy-other sy-readwrite sy-shell">BUCKET</span></span>.<span class="sy-meta sy-group sy-expansion sy-parameter sy-shell"><span class="sy-punctuation sy-definition sy-variable sy-shell">$</span><span class="sy-variable sy-other sy-readwrite sy-shell">REGION</span></span>.digitaloceanspaces.com <span class="sy-punctuation sy-separator sy-continuation sy-line sy-shell">\
</span><span class="sy-variable sy-parameter sy-option sy-shell"><span class="sy-punctuation sy-definition sy-parameter sy-shell">    --</span>region</span> <span class="sy-meta sy-group sy-expansion sy-parameter sy-shell"><span class="sy-punctuation sy-definition sy-variable sy-shell">$</span><span class="sy-variable sy-other sy-readwrite sy-shell">REGION</span></span> <span class="sy-punctuation sy-separator sy-continuation sy-line sy-shell">\
</span>    setpolicy policy.json s3://<span class="sy-meta sy-group sy-expansion sy-parameter sy-shell"><span class="sy-punctuation sy-definition sy-variable sy-shell">$</span><span class="sy-variable sy-other sy-readwrite sy-shell">BUCKET</span></span> <span class="sy-punctuation sy-separator sy-continuation sy-line sy-shell">\
</span><span class="sy-variable sy-parameter sy-option sy-shell"><span class="sy-punctuation sy-definition sy-parameter sy-shell">    --</span>acl-public</span></span>
</span></code></pre>
        <p>It&#39;s a bit quirky, as the DO web interface still shows the files as private, but they are actually public, and this public status also applies to files uploaded in the future.</p>
        <p>But all that done with, the good news is that <a href="/notes/projects_pic_store">Pic Store</a> is now uploading files to cloud storage. Many thanks to <a href="https://hugo.md/post/setting-bucket-policy-digital-ocean-spaces/">Hugo</a> for figuring out this policy file solution and writing about it!</p>



